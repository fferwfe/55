<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CV è‡ªç”±æ¨¡å¼ - ç©å®¶ç«¯</title>
    <style>
        :root { --main: #2c3e50; --accent: #e67e22; --bg: #f5f7fa; --green: #27ae60; --red: #e74c3c; --blue: #3498db; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 500px; display: none; }
        .panel { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 10px; text-align: center; }
        .dice-display { display: flex; justify-content: center; gap: 8px; margin: 15px 0; min-height: 50px; }
        .dice { width: 45px; height: 45px; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.2rem; background: #34495e; border: 2px solid #2c3e50; }
        .market { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .card { border: 1px solid #eee; padding: 10px; border-radius: 10px; background: #fafafa; min-height: 130px; display: flex; flex-direction: column; justify-content: space-between; text-align: center; }
        .btn { padding: 15px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; color: white; width: 100%; margin: 5px 0; font-size: 16px; }
        .btn:disabled { background: #ccc !important; }
        #setup { position: fixed; inset: 0; background: white; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
    </style>
</head>
<body>

    <div id="setup">
        <h2>ğŸ§¬ é¸æ“‡ç©å®¶ä½ç½®</h2>
        <p id="loading-msg">æ­£åœ¨é€£ç·šè‡³é›²ç«¯...</p>
        <div id="p-btns" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; max-width: 300px;"></div>
    </div>

    <div class="container" id="game-ui">
        <div class="panel">
            <h2 id="job-title" style="margin:0;">è¼‰å…¥è·æ¥­ä¸­...</h2>
            <div id="dice-container" class="dice-display"></div>
            <button class="btn" style="background:var(--accent)" id="roll-btn" onclick="window.handleRoll()">ğŸ² æ“²éª°å­</button>
            <p id="res-summary" style="font-weight:bold; color:var(--main); font-size:14px;">è«‹é»æ“Šæ“²éª°å­</p>
        </div>

        <div class="market" id="market-list"></div>

        <div style="margin-top: 15px;">
            <button class="btn" style="background:var(--main)" id="end-btn" onclick="window.handleEndTurn()">ğŸ é‡ç½®/ä¸‹ä¸€å›åˆ</button>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const config = { databaseURL: "https://life-24445-default-rtdb.asia-southeast1.firebasedatabase.app" };
    const app = initializeApp(config);
    const db = getDatabase(app);
    const gRef = ref(db, 'cv_game_state');

    let myId = null;
    let state = null;
    let myCurrentDice = [];
    let localHasRolled = false;

    const iconToName = { 'ğŸ’°': 'é‡‘éŒ¢', 'ğŸ§ ': 'æ™ºæ…§', 'ğŸ¤': 'äººéš›', 'ğŸƒ': 'å¥åº·', 'ğŸ˜Š': 'ç¬‘è‡‰' };

    // åˆå§‹åŒ–æŒ‰éˆ•
    const pContainer = document.getElementById('p-btns');
    for(let i=1; i<=10; i++) {
        let b = document.createElement('button');
        b.className = "btn"; b.style.background = "var(--blue)"; b.innerText = "ä½ç½® " + i;
        b.onclick = () => {
            myId = i;
            document.getElementById('setup').style.display = 'none';
            document.getElementById('game-ui').style.display = 'block';
            update(ref(db, `cv_game_state/players/${i}`), { active: true });
        };
        pContainer.appendChild(b);
    }

    // ç›£è½é›²ç«¯
    onValue(gRef, (snap) => {
        state = snap.val();
        if(!state) {
            document.getElementById('loading-msg').innerText = "âš ï¸ è³‡æ–™åº«æœªåˆå§‹åŒ–ï¼Œè«‹é–‹å•Ÿä¸Šå¸ç«¯æŒ‰ä¸‹ç´…è‰²æŒ‰éˆ•";
            return;
        }
        document.getElementById('loading-msg').innerText = "âœ… é€£ç·šæˆåŠŸï¼Œè«‹é¸æ“‡ä½ç½®";
        if(!myId) return;

        // æ›´æ–° UI
        document.getElementById('job-title').innerText = state.players[myId].job;
        document.getElementById('roll-btn').disabled = localHasRolled;
        document.getElementById('end-btn').disabled = !localHasRolled;
        
        renderMarket();
    });

    window.handleRoll = () => {
        const icons = ['ğŸ’°','ğŸ§ ','ğŸ¤','ğŸƒ','ğŸ˜Š'];
        myCurrentDice = [];
        for(let i=0; i<6; i++) myCurrentDice.push(icons[Math.floor(Math.random()*5)]);
        
        const diceHtml = myCurrentDice.map(d => `<div class="dice">${d}</div>`).join('');
        document.getElementById('dice-container').innerHTML = diceHtml;
        localHasRolled = true;
        document.getElementById('res-summary').innerText = "âœ¨ éª°å­å·²å®šï¼Œè«‹é¸æ“‡å…Œæ›";
        renderMarket();
    };

    window.handleBuy = (idx) => {
        const card = state.marketCards[idx];
        const diceCounts = {};
        myCurrentDice.forEach(d => { const name = iconToName[d]; diceCounts[name] = (diceCounts[name] || 0) + 1; });

        let smileCount = diceCounts['ç¬‘è‡‰'] || 0;
        let neededSmiles = 0;
        let missingInfo = "";

        card.cost.split(',').forEach(item => {
            let [name, amtStr] = item.trim().split('x');
            let amt = parseInt(amtStr) || 1;
            let have = diceCounts[name.trim()] || 0;
            if (have < amt) {
                neededSmiles += (amt - have);
                missingInfo += `\n- ${name.trim()} ç¼º ${amt - have}`;
            }
        });

        if (smileCount < neededSmiles) {
            alert(`âŒ è³‡æºä¸è¶³ï¼${missingInfo}\n(éœ€ ${neededSmiles} å€‹ç¬‘è‡‰ï¼Œä½ åªæœ‰ ${smileCount} å€‹)`);
            return;
        }

        if(!confirm(`âœ… è³‡æºé€šéï¼(è€—è²» ${neededSmiles} å€‹ç¬‘è‡‰)\nç¢ºå®šå…Œæ›ã€Œ${card.name}ã€ï¼Ÿ`)) return;

        const p = state.players[myId];
        if(!p.allTags) p.allTags = {};
        card.gains.split(',').forEach(g => {
            let [name, amtStr] = g.trim().split('x');
            p.allTags[name.trim()] = (p.allTags[name.trim()] || 0) + (parseInt(amtStr) || 1);
        });

        update(ref(db, `cv_game_state/players/${myId}`), { allTags: p.allTags }).then(() => {
            alert("ğŸ‰ å…Œæ›æˆåŠŸï¼");
            window.handleEndTurn();
        });
    };

    window.handleEndTurn = () => {
        localHasRolled = false;
        myCurrentDice = [];
        document.getElementById('dice-container').innerHTML = "";
        document.getElementById('res-summary').innerText = "è«‹é»æ“Šæ“²éª°å­";
        renderMarket();
    };

    function renderMarket() {
        if(!state || !state.marketCards) return;
        document.getElementById('market-list').innerHTML = state.marketCards.map((c, i) => `
            <div class="card">
                <b style="color:var(--main); font-size:14px;">${c.name}</b>
                <div style="font-size:11px; margin:5px 0;">
                    <span style="color:var(--red)">éœ€ï¼š${c.cost}</span><br>
                    <span style="color:var(--green)">å¾—ï¼š${c.gains}</span>
                </div>
                <button class="btn" style="background:var(--green); font-size:12px; height:35px; padding:0;" 
                    ${!localHasRolled ? 'disabled' : ''} onclick="window.handleBuy(${i})">å…Œæ›</button>
            </div>
        `).join('');
    }
</script>
</body>
</html>