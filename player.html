<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const config = { databaseURL: "https://life-24445-default-rtdb.asia-southeast1.firebasedatabase.app" };
    const app = initializeApp(config);
    const db = getDatabase(app);
    const gRef = ref(db, 'cv_game_state');

    let myId = null;
    let state = null;
    let localHasRolled = false; // æ”¹ç‚ºæœ¬åœ°æ§åˆ¶ï¼Œä¸å½±éŸ¿åˆ¥äºº

    // é¸æ“‡ä½ç½®
    const pContainer = document.getElementById('p-btns');
    for(let i=1; i<=10; i++) {
        let b = document.createElement('button');
        b.className = "btn"; b.style.background = "var(--blue)"; b.innerText = "ä½ç½® " + i;
        b.onclick = () => { 
            myId = i; 
            document.getElementById('setup').style.display = 'none'; 
            document.getElementById('game-ui').style.display = 'block';
            update(ref(db, `cv_game_state/players/${i}`), { active: true });
        };
        pContainer.appendChild(b);
    }

    onValue(gRef, (snap) => {
        state = snap.val();
        if(!state || !myId) return;

        const p = state.players[myId];
        document.getElementById('p-id').innerText = myId;
        document.getElementById('round-num').innerText = state.currentRound;
        document.getElementById('job-title').innerText = p.job;
        
        // è‡ªç”±æ¨¡å¼ï¼šåªçœ‹è‡ªå·±æ˜¯å¦æ“²ééª°å­
        document.getElementById('roll-btn').disabled = localHasRolled;
        document.getElementById('end-btn').disabled = !localHasRolled;
        
        document.getElementById('res-summary').innerText = localHasRolled ? "âœ¨ å…Œæ›å¡ç‰‡æˆ–é‡ç½®è¡Œå‹•" : "ğŸ‘‰ é»æ“Šé–‹å§‹æ“²éª°";

        renderMarket(true, localHasRolled);
    });

    window.handleRoll = () => {
        const icons = ['ğŸ’°','ğŸ§ ','ğŸ¤','ğŸƒ','ğŸ˜Š'];
        const res = []; 
        for(let i=0; i<6; i++) res.push(icons[Math.floor(Math.random()*5)]);
        
        // é¡¯ç¤ºåœ¨ç•«é¢ä¸Š
        const diceHtml = res.map(d => `<div class="dice">${d}</div>`).join('');
        document.getElementById('dice-container').innerHTML = diceHtml;
        localHasRolled = true;
        renderMarket(true, true);
    };

    window.handleBuy = (idx) => {
        const card = state.marketCards[idx];
        if(!confirm(`ç¢ºå®šè¦å…Œæ›ã€Œ${card.name}ã€å—ï¼Ÿ`)) return;

        const p = state.players[myId];
        if(!p.allTags) p.allTags = {};

        try {
            const gains = card.gains.split(',');
            gains.forEach(g => {
                let [name, amtStr] = g.split('x');
                let amt = parseInt(amtStr) || 1;
                p.allTags[name.trim()] = (p.allTags[name.trim()] || 0) + amt;
            });

            update(ref(db, `cv_game_state/players/${myId}`), { allTags: p.allTags })
                .then(() => alert("âœ… å…Œæ›æˆåŠŸï¼æ¨™ç±¤å·²æ›´æ–°"));
        } catch (e) {
            alert("å¡ç‰‡æ ¼å¼éŒ¯èª¤");
        }
    };

    window.handleEndTurn = () => {
        // è‡ªç”±æ¨¡å¼ï¼šçµæŸå›åˆç­‰æ–¼ã€Œé‡ç½®è‡ªå·±çš„æ“²éª°ç‹€æ…‹ã€
        localHasRolled = false;
        document.getElementById('dice-container').innerHTML = "";
        alert("æº–å‚™å¥½é€²è¡Œä¸‹ä¸€æ¬¡è¡Œå‹•äº†ï¼");
        // å¦‚æœæƒ³è¦å…¨å±€è·³è½‰è¼ªæ¬¡ï¼Œå¯ä»¥åœ¨é€™è£¡åŠ å…¥ update(gRef, { currentRound: ... })
    };

    function renderMarket(isMyTurn, hasRolled) {
        if(!state.marketCards) return;
        const container = document.getElementById('market-list');
        container.innerHTML = state.marketCards.map((c, i) => `
            <div class="card">
                <b>${c.name}</b>
                <div style="margin: 5px 0; font-size:11px;">
                    <span style="color:var(--red)">éœ€ï¼š${c.cost}</span><br>
                    <span style="color:var(--green)">å¾—ï¼š${c.gains}</span>
                </div>
                <button class="btn" style="background:var(--green); font-size:12px; height:35px; padding:0;" 
                    ${!hasRolled ? 'disabled' : ''} onclick="window.handleBuy(${i})">å…Œæ›</button>
            </div>
        `).join('');
    }
</script>
