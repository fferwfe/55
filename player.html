<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CV ç©å®¶æ“ä½œ</title>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; text-align: center; padding: 15px; }
        .card { background: white; border-radius: 10px; padding: 15px; margin: 10px 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn { padding: 15px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; width: 100%; margin: 5px 0; }
        .btn-roll { background: #e67e22; color: white; }
        .btn-buy { background: #27ae60; color: white; }
        #setup { position: fixed; inset: 0; background: white; z-index: 100; display: flex; flex-direction: column; justify-content: center; padding: 20px; }
    </style>
</head>
<body>
    <div id="setup">
        <h2>ğŸ§¬ CV åŠ å…¥éŠæˆ²</h2>
        <input type="text" id="name" placeholder="è¼¸å…¥æš±ç¨±" style="padding:15px; margin-bottom:10px; font-size:1rem;">
        <div id="p-btns" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;"></div>
    </div>

    <div id="game" style="display:none;">
        <h3 id="info">é€£ç·šä¸­...</h3>
        <button class="btn btn-roll" id="rollBtn" onclick="doRoll()">ğŸ² æ“²éª°å­</button>
        <div id="diceDisp" style="margin: 15px 0; font-size: 20px; font-weight:bold;"></div>
        <div id="market"></div>
        <button class="btn" style="background:#2c3e50; color:white;" onclick="doEnd()">ğŸ çµæŸå›åˆ</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const config = { 
            apiKey: "AIzaSyA5x6Q2tMCR972PnHw6yzo8X1owq8n6Ppc", 
            authDomain: "life-24445.firebaseapp.com", 
            databaseURL: "https://life-24445-default-rtdb.asia-southeast1.firebasedatabase.app", 
            projectId: "life-24445" 
        };
        const app = initializeApp(config);
        const db = getDatabase(app);
        const gRef = ref(db, 'cv_game_state');
        let myId, state;

        for(let i=1; i<=10; i++) {
            let b = document.createElement('button'); b.innerText = "P"+i; b.className="btn"; b.style.background="#3498db"; b.style.color="white";
            b.id = "btn-join-"+i;
            b.onclick = () => {
                let n = document.getElementById('name').value; if(!n) return alert("è«‹è¼¸å");
                myId = i; update(ref(db, `cv_game_state/players/${i}`), { active:true, name:n, tags:{'é‡‘éŒ¢':0,'æ™ºæ…§':0,'äººéš›':0,'å¥åº·':0} });
                document.getElementById('setup').style.display='none'; document.getElementById('game').style.display='block';
            };
            document.getElementById('p-btns').appendChild(b);
        }

        onValue(gRef, (s) => {
            state = s.val(); if(!state) return;
            for(let i=1; i<=10; i++) { if(state.players[i].active) { let target = document.getElementById("btn-join-"+i); if(target) target.disabled=true; } }
            if(!myId) return;
            let isMe = state.currentTurn == myId;
            document.getElementById('info').innerText = `ç¬¬ ${state.currentRound} è¼ª - ${isMe ? "ğŸŸ¢ ä½ çš„å›åˆ" : "â³ ç­‰ä»–äºº"}`;
            document.getElementById('rollBtn').disabled = !isMe || state.turnAction.hasRolled;
            document.getElementById('diceDisp').innerText = (state.turnAction.dice || []).join(' | ');
            document.getElementById('market').innerHTML = state.market.map((c,idx) => `
                <div class="card">æˆå°±é …ç›® #${idx+1} ${c===null?'âŒ':''} <button class="btn btn-buy" onclick="doBuy(${idx})" ${!isMe || !state.turnAction.hasRolled || c===null?'disabled':''}>å…Œæ›</button></div>
            `).join('');
        });

        window.doRoll = () => {
            if(!state) return;
            let ds = ['ğŸ’°','ğŸ§ ','ğŸ¤','ğŸƒ','ğŸ˜Š'];
            let res = []; for(let i=0; i<6; i++) res.push(ds[Math.floor(Math.random()*5)]);
            update(ref(db, 'cv_game_state/turnAction'), { hasRolled: true, dice: res });
        };
        window.doBuy = (idx) => {
            if(!state) return;
            let nm = [...state.market]; nm[idx] = null;
            update(gRef, { market: nm });
        };
        window.doEnd = () => {
            if(!state || !state.currentTurn) return;
            let nt = state.currentTurn + 1; if(nt > 10) nt = 1;
            update(gRef, { currentTurn: nt, turnAction: {hasRolled:false, dice:[]} });
        };
    </script>
</body>
</html>
