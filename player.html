<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    // --- Firebase è¨­å®š ---
    const config = { databaseURL: "https://life-24445-default-rtdb.asia-southeast1.firebasedatabase.app" };
    const app = initializeApp(config);
    const db = getDatabase(app);
    const gRef = ref(db, 'cv_game_state');

    let myId = null;
    let state = null;

    // --- æ ¸å¿ƒé‚è¼¯ï¼šå°‡å‡½æ•¸å¼·åˆ¶æ›è¼‰åˆ° windowï¼Œè§£æ±º ReferenceError ---

    window.roll = () => {
        if (!state) return;
        const icons = ['ğŸ’°','ğŸ§ ','ğŸ¤','ğŸƒ','ğŸ˜Š'];
        const rolled = []; 
        for(let i=0; i<6; i++) rolled.push(icons[Math.floor(Math.random()*5)]);
        
        update(ref(db, 'cv_game_state/turnAction'), { 
            hasRolled: true, 
            dice: rolled 
        }).catch(err => console.error("æ“²éª°å¤±æ•—:", err));
    };

    window.buy = (idx) => {
        if (!state || !state.marketCards) return;
        const card = state.marketCards[idx];
        
        if (confirm(`ç¢ºå®šè¦å…Œæ›ã€Œ${card.name}ã€å—ï¼Ÿ\n(è«‹ä¸Šå¸ç¢ºèªè³‡æºæ˜¯å¦è¶³å¤ )`)) {
            const p = state.players[myId];
            if (!p.allTags) p.allTags = {};

            // è§£æçå‹µä¸¦æ›´æ–°è‡³é›²ç«¯
            const gains = card.gains.split(',');
            gains.forEach(g => {
                let [name, amtStr] = g.split('x');
                let amt = parseInt(amtStr) || 1;
                p.allTags[name.trim()] = (p.allTags[name.trim()] || 0) + amt;
            });

            update(ref(db, `cv_game_state/players/${myId}`), { allTags: p.allTags })
                .then(() => alert("âœ… å…Œæ›æˆåŠŸï¼"))
                .catch(err => alert("âŒ å…Œæ›å¤±æ•—"));
        }
    };

    window.endTurn = () => {
        if (!state) return;
        let next = (state.currentTurn % 10) + 1;
        let round = state.currentRound;
        if(next === 1) round++;
        
        update(gRef, { 
            currentTurn: next, 
            currentRound: round,
            turnAction: { hasRolled: false, dice: [] } 
        });
    };

    // --- ä½ç½®é¸æ“‡é‚è¼¯ ---
    const pContainer = document.getElementById('p-btns');
    for(let i=1; i<=10; i++) {
        let b = document.createElement('button');
        b.className = "btn"; b.style.background = "var(--blue)"; b.innerText = "ä½ç½® " + i;
        b.onclick = () => { 
            myId = i; 
            document.getElementById('setup').style.display = 'none'; 
            document.getElementById('game-ui').style.display = 'block';
            update(ref(db, `cv_game_state/players/${i}`), { active: true });
        };
        pContainer.appendChild(b);
    }

    // --- è³‡æ–™åŒæ­¥æ¸²æŸ“ ---
    onValue(gRef, (snap) => {
        state = snap.val();
        if(!state || !myId) return;

        const isMyTurn = state.currentTurn == myId;
        const turnData = state.turnAction || { hasRolled: false, dice: [] };

        document.getElementById('p-id').innerText = myId + (isMyTurn ? " (ä½ çš„å›åˆ)" : "");
        document.getElementById('round-num').innerText = state.currentRound;
        document.getElementById('job-title').innerText = state.players[myId].job;
        
        document.getElementById('roll-btn').disabled = !isMyTurn || turnData.hasRolled;
        document.getElementById('end-btn').disabled = !isMyTurn || !turnData.hasRolled;

        const diceHtml = (turnData.dice || []).map(d => `<div class="dice">${d}</div>`).join('');
        document.getElementById('dice-container').innerHTML = diceHtml;

        renderMarket(isMyTurn, turnData.hasRolled);
    });

    function renderMarket(isMyTurn, hasRolled) {
        if (!state.marketCards) return;
        document.getElementById('market-list').innerHTML = state.marketCards.map((c, i) => `
            <div class="card">
                <b>${c.name}</b>
                <div style="font-size:10px; margin:5px 0;">
                    <span style="color:var(--red)">éœ€:${c.cost}</span><br>
                    <span style="color:var(--green)">å¾—:${c.gains}</span>
                </div>
                <button class="btn" style="background:var(--green); font-size:12px; height:30px; line-height:30px; padding:0;" 
                    ${!isMyTurn || !hasRolled ? 'disabled' : ''} onclick="window.buy(${i})">å…Œæ›</button>
            </div>
        `).join('');
    }
</script>
