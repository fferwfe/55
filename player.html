<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CV äººç”Ÿå±¥æ­· - ç©å®¶ç«¯</title>
    <style>
        :root { --main: #2c3e50; --accent: #e67e22; --bg: #f5f7fa; --green: #27ae60; --red: #e74c3c; --blue: #3498db; --gold: #f1c40f; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; touch-action: manipulation; }
        .container { width: 100%; max-width: 500px; }
        .header-info { display: flex; justify-content: space-between; background: var(--main); color: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; font-weight: bold; font-size: 14px; }
        .panel { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 10px; }
        .dice-display { display: flex; justify-content: center; gap: 6px; margin: 10px 0; min-height: 50px; }
        .dice { width: 45px; height: 45px; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.2rem; background: #34495e; border: 2px solid #2c3e50; }
        .market { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .card { border: 1px solid #eee; padding: 10px; border-radius: 10px; background: #fafafa; min-height: 130px; text-align: center; display: flex; flex-direction: column; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .btn { padding: 15px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; color: white; width: 100%; margin: 5px 0; font-size: 16px; -webkit-appearance: none; }
        .btn:active { opacity: 0.8; transform: scale(0.98); }
        .btn:disabled { background: #ccc !important; cursor: not-allowed; transform: none; }
        #setup { position: fixed; inset: 0; background: white; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; }
        .res-text { font-size: 13px; font-weight: bold; margin: 4px 0; display: block; }
    </style>
</head>
<body>

    <div id="setup">
        <h2 style="color: var(--main);">ğŸ§¬ é¸æ“‡ä½ çš„ç©å®¶ä½ç½®</h2>
        <p style="color: #666; font-size: 14px;">è«‹å…ˆç¢ºä¿ä¸Šå¸ç«¯å·²å•Ÿå‹•éŠæˆ²</p>
        <div id="p-btns" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; width: 100%; max-width: 300px;"></div>
    </div>

    <div class="container" id="game-ui" style="display:none;">
        <div class="header-info">
            <span>ğŸ“… ç¬¬ <span id="round-num">1</span> è¼ª</span>
            <span>ğŸ‘¤ ç©å®¶ <span id="p-id"></span></span>
        </div>

        <div class="panel">
            <h2 id="job-title" style="text-align:center; margin:0; color: var(--main);">è¼‰å…¥è·æ¥­ä¸­...</h2>
            <div id="dice-container" class="dice-display"></div>
            <button class="btn" style="background:var(--accent)" id="roll-btn" onclick="window.handleRoll()">ğŸ² æ“²éª°å­</button>
            <div id="res-summary" style="margin: 10px; font-weight: bold; color: var(--main); text-align:center; font-size: 14px;">ç­‰å¾…è³‡æ–™åŒæ­¥...</div>
        </div>

        <div class="market" id="market-list"></div>

        <div style="margin-top: 15px;">
            <button class="btn" style="background:var(--main)" id="end-btn" onclick="window.handleEndTurn()">ğŸ çµæŸå›åˆ</button>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    // --- Firebase é…ç½® ---
    const config = { databaseURL: "https://life-24445-default-rtdb.asia-southeast1.firebasedatabase.app" };
    const app = initializeApp(config);
    const db = getDatabase(app);
    const gRef = ref(db, 'cv_game_state');

    let myId = null;
    let state = null;

    // --- 1. ç”Ÿæˆä½ç½®æŒ‰éˆ• ---
    const pContainer = document.getElementById('p-btns');
    for(let i=1; i<=10; i++) {
        let b = document.createElement('button');
        b.className = "btn";
        b.style.background = "var(--blue)";
        b.innerText = "ä½ç½® " + i;
        b.onclick = () => { 
            myId = i; 
            document.getElementById('setup').style.display = 'none'; 
            document.getElementById('game-ui').style.display = 'block';
            update(ref(db, `cv_game_state/players/${i}`), { active: true });
        };
        pContainer.appendChild(b);
    }

    // --- 2. ç›£è½é›²ç«¯è³‡æ–™ (æ‰‹æ©ŸåŒæ­¥æ ¸å¿ƒ) ---
    onValue(gRef, (snap) => {
        state = snap.val();
        if(!state) {
            document.getElementById('res-summary').innerText = "è«‹é€šçŸ¥ä¸Šå¸åˆå§‹åŒ–éŠæˆ²ï¼";
            return;
        }
        if(!myId) return;

        const isMyTurn = state.currentTurn == myId;
        const turnData = state.turnAction || { hasRolled: false, dice: [] };

        // æ›´æ–° UI è³‡è¨Š
        document.getElementById('p-id').innerText = myId + (isMyTurn ? " (æ›ä½ æ“ä½œ)" : "");
        document.getElementById('round-num').innerText = state.currentRound;
        document.getElementById('job-title').innerText = state.players[myId].job;
        
        // æ§åˆ¶æŒ‰éˆ•å•Ÿåº¦
        document.getElementById('roll-btn').disabled = !isMyTurn || turnData.hasRolled;
        document.getElementById('end-btn').disabled = !isMyTurn || !turnData.hasRolled;

        // æ¸²æŸ“éª°å­
        const diceHtml = (turnData.dice || []).map(d => `<div class="dice">${d}</div>`).join('');
        document.getElementById('dice-container').innerHTML = diceHtml;
        
        // æç¤ºèªæ›´æ–°
        const summaryMsg = isMyTurn 
            ? (turnData.hasRolled ? "âœ¨ éª°å­å·²å®šï¼Œè«‹é¸æ“‡å…Œæ›å¡ç‰‡" : "ğŸ‘‰ è«‹é»æ“Šæ“²éª°å­æŒ‰éˆ•")
            : `â³ ç­‰å¾…ç©å®¶ P${state.currentTurn} è¡Œå‹•ä¸­...`;
        document.getElementById('res-summary').innerText = summaryMsg;

        renderMarket(isMyTurn, turnData.hasRolled);
    });

    // --- 3. å°‡å‹•ä½œæ›è¼‰åˆ° windowï¼Œæ‰‹æ©Ÿç€è¦½å™¨ onclick æ‰èƒ½æŠ“åˆ° ---
    
    window.handleRoll = () => {
        const icons = ['ğŸ’°','ğŸ§ ','ğŸ¤','ğŸƒ','ğŸ˜Š'];
        const res = []; 
        for(let i=0; i<6; i++) res.push(icons[Math.floor(Math.random()*5)]);
        
        update(ref(db, 'cv_game_state/turnAction'), { 
            hasRolled: true, 
            dice: res 
        }).catch(e => alert("é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯"));
    };

    window.handleBuy = (idx) => {
        const card = state.marketCards[idx];
        if(!confirm(`ç¢ºå®šè¦å…Œæ›ã€Œ${card.name}ã€å—ï¼Ÿ`)) return;

        const p = state.players[myId];
        if(!p.allTags) p.allTags = {};

        // ç°¡æ˜“è§£æçå‹µå­—ä¸²ä¸¦å­˜å›é›²ç«¯
        try {
            const gains = card.gains.split(',');
            gains.forEach(g => {
                let [name, amtStr] = g.split('x');
                let amt = parseInt(amtStr) || 1;
                p.allTags[name.trim()] = (p.allTags[name.trim()] || 0) + amt;
            });

            update(ref(db, `cv_game_state/players/${myId}`), { allTags: p.allTags })
                .then(() => alert("âœ… å…Œæ›æˆåŠŸï¼æ¨™ç±¤å·²æ›´æ–°è‡³ä¸Šå¸ç«¯"));
        } catch (e) {
            alert("è§£æéŒ¯èª¤ï¼Œè«‹ä¸Šå¸æª¢æŸ¥å¡ç‰‡è¨­å®šæ ¼å¼");
        }
    };

    window.handleEndTurn = () => {
        let next = (state.currentTurn % 10) + 1;
        let round = state.currentRound;
        if(next === 1) round++;
        
        update(gRef, { 
            currentTurn: next, 
            currentRound: round,
            turnAction: { hasRolled: false, dice: [] } 
        });
    };

    // --- 4. å¸‚å ´æ¸²æŸ“ ---
    function renderMarket(isMyTurn, hasRolled) {
        if(!state.marketCards) return;
        const container = document.getElementById('market-list');
        container.innerHTML = state.marketCards.map((c, i) => `
            <div class="card">
                <b style="color:var(--main); font-size:14px;">${c.name}</b>
                <div style="margin: 5px 0;">
                    <span class="res-text" style="color:var(--red)">éœ€ï¼š${c.cost}</span>
                    <span class="res-text" style="color:var(--green)">å¾—ï¼š${c.gains}</span>
                </div>
                <button class="btn" style="background:var(--green); font-size:13px; height:35px; padding:0;" 
                    ${!isMyTurn || !hasRolled ? 'disabled' : ''} onclick="window.handleBuy(${i})">å…Œæ›å¡ç‰‡</button>
            </div>
        `).join('');
    }
</script>
</body>
</html>
