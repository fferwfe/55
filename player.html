<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const config = { databaseURL: "https://life-24445-default-rtdb.asia-southeast1.firebasedatabase.app" };
    const app = initializeApp(config);
    const db = getDatabase(app);
    const gRef = ref(db, 'cv_game_state');

    let myId = null, state = null;
    let myCurrentDice = []; // å­˜å„²ç›®å‰æ“²å‡ºçš„éª°å­
    let localHasRolled = false;

    // è³‡æºå°ç…§è¡¨ (ä¸­è‹±è½‰æ›)
    const iconToName = { 'ğŸ’°': 'é‡‘éŒ¢', 'ğŸ§ ': 'æ™ºæ…§', 'ğŸ¤': 'äººéš›', 'è·‘': 'å¥åº·', 'ğŸƒ': 'å¥åº·', 'ğŸ˜Š': 'ç¬‘è‡‰' };

    // 1. åˆå§‹åŒ–ä½ç½®é¸æ“‡ (çœç•¥é‡è¤‡ä»£ç¢¼ï¼ŒåŒå‰ç‰ˆ...)
    const pContainer = document.getElementById('p-btns');
    for(let i=1; i<=10; i++) {
        let b = document.createElement('button'); b.className = "btn"; b.style.background = "var(--blue)"; b.innerText = "ä½ç½® " + i;
        b.onclick = () => { myId = i; document.getElementById('setup').style.display = 'none'; document.getElementById('game-ui').style.display = 'block'; update(ref(db, `cv_game_state/players/${i}`), { active: true }); };
        pContainer.appendChild(b);
    }

    onValue(gRef, (snap) => {
        state = snap.val();
        if(!state || !myId) return;
        document.getElementById('p-id').innerText = myId;
        document.getElementById('round-num').innerText = state.currentRound;
        document.getElementById('job-title').innerText = state.players[myId].job;
        document.getElementById('roll-btn').disabled = localHasRolled;
        document.getElementById('end-btn').disabled = !localHasRolled;
        renderMarket(localHasRolled);
    });

    // ğŸ² æ“²éª°å­ä¸¦è¨ˆç®—ç•¶å‰è³‡æº
    window.handleRoll = () => {
        const icons = ['ğŸ’°','ğŸ§ ','ğŸ¤','ğŸƒ','ğŸ˜Š'];
        myCurrentDice = []; 
        for(let i=0; i<6; i++) myCurrentDice.push(icons[Math.floor(Math.random()*5)]);
        
        const diceHtml = myCurrentDice.map(d => `<div class="dice">${d}</div>`).join('');
        document.getElementById('dice-container').innerHTML = diceHtml;
        
        localHasRolled = true;
        renderMarket(true);
    };

    // ğŸ›’ å…Œæ›é‚è¼¯ï¼šè‡ªå‹•è¨ˆç®—è³‡æºæ˜¯å¦è¶³å¤ 
    window.handleBuy = (idx) => {
        const card = state.marketCards[idx];
        
        // --- æ ¸å¿ƒï¼šè³‡æºè¨ˆç®— ---
        const diceCounts = {}; // çµ±è¨ˆæ‰‹ä¸­éª°å­
        myCurrentDice.forEach(d => {
            const name = iconToName[d];
            diceCounts[name] = (diceCounts[name] || 0) + 1;
        });

        const smileCount = diceCounts['ç¬‘è‡‰'] || 0; // ç¬‘è‡‰è¬èƒ½è³‡æº
        let neededSmiles = 0;
        let canAfford = true;
        let missingList = [];

        // è§£ææˆæœ¬ï¼Œä¾‹å¦‚ "æ™ºæ…§x2,é‡‘éŒ¢x1"
        const costItems = card.cost.split(',');
        costItems.forEach(item => {
            let [name, amtStr] = item.trim().split('x');
            let amt = parseInt(amtStr) || 1;
            let currentOwned = diceCounts[name] || 0;
            
            if (currentOwned < amt) {
                neededSmiles += (amt - currentOwned);
                missingList.push(`${name}ç¼º${amt - currentOwned}`);
            }
        });

        // åˆ¤æ–·ç¬‘è‡‰æ˜¯å¦è¶³ä»¥å¡«è£œç©ºç¼º
        if (smileCount < neededSmiles) {
            alert(`âŒ è³‡æºä¸è¶³ï¼\næŒæœ‰ï¼š${JSON.stringify(diceCounts)}\n${missingList.join('\n')}\n(éœ€è¦ ${neededSmiles} å€‹ç¬‘è‡‰ï¼Œä½ åªæœ‰ ${smileCount} å€‹)`);
            return;
        }

        // --- è³‡æºè¶³å¤ ï¼ŒåŸ·è¡Œå…Œæ› ---
        if(!confirm(`âœ… è³‡æºç¢ºèªé€šé (è€—è²» ${neededSmiles} å€‹ç¬‘è‡‰ç•¶è¬èƒ½è³‡æº)\nç¢ºå®šå…Œæ›ã€Œ${card.name}ã€ï¼Ÿ`)) return;

        const p = state.players[myId];
        if(!p.allTags) p.allTags = {};
        const gains = card.gains.split(',');
        gains.forEach(g => {
            let [name, amtStr] = g.trim().split('x');
            p.allTags[name] = (p.allTags[name] || 0) + (parseInt(amtStr) || 1);
        });

        update(ref(db, `cv_game_state/players/${myId}`), { allTags: p.allTags }).then(() => {
            alert("ğŸ‰ å…Œæ›æˆåŠŸï¼å·²åŠ å…¥ä½ çš„å±¥æ­·ã€‚");
            window.handleEndTurn(); // å…Œæ›å®Œè‡ªå‹•é‡ç½®éª°å­
        });
    };

    window.handleEndTurn = () => {
        localHasRolled = false;
        myCurrentDice = [];
        document.getElementById('dice-container').innerHTML = "";
    };

    function renderMarket(hasRolled) {
        if(!state.marketCards) return;
        document.getElementById('market-list').innerHTML = state.marketCards.map((c, i) => `
            <div class="card">
                <b>${c.name}</b>
                <div style="margin: 5px 0; font-size:11px;">
                    <span style="color:var(--red)">éœ€ï¼š${c.cost}</span><br>
                    <span style="color:var(--green)">å¾—ï¼š${c.gains}</span>
                </div>
                <button class="btn" style="background:var(--green); font-size:12px; height:35px; padding:0;" 
                    ${!hasRolled ? 'disabled' : ''} onclick="window.handleBuy(${i})">å…Œæ›</button>
            </div>
        `).join('');
    }
</script>
