<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CV äººç”Ÿå±¥æ­· - å…¬å¹³ç«¶è³½ç‰ˆ</title>
    <style>
        :root { --main: #2c3e50; --accent: #e67e22; --bg: #f5f7fa; --green: #27ae60; --red: #e74c3c; --gold: #f1c40f; }
        body { font-family: 'PingFang TC', sans-serif; background: var(--bg); margin: 0; padding: 10px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 500px; }
        .header-info { display: flex; justify-content: space-between; background: var(--main); color: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; font-weight: bold; font-size: 14px; }
        .panel { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .player-card { text-align: center; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 15px; }
        .secret-area { background: #f8f9fa; padding: 10px; border-radius: 10px; margin: 10px 0; border: 2px dashed #cbd5e0; }
        .secret-text { display: none; color: var(--red); font-weight: bold; font-size: 1.2rem; }
        
        /* éª°å­æ¨£å¼ */
        .dice-display { display: flex; justify-content: center; gap: 6px; margin: 10px 0; min-height: 60px; }
        .dice { width: 50px; height: 50px; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.7rem; box-shadow: 0 3px 0 rgba(0,0,0,0.1); }
        
        /* å•†åº—æ¨£å¼ */
        .market { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .card { border: 2px solid #eee; padding: 12px; border-radius: 12px; text-align: center; transition: 0.3s; position: relative; display: flex; flex-direction: column; justify-content: space-between; min-height: 110px; }
        
        /* äº®é»ƒæ¡†é‚è¼¯ï¼šç•¶ç©å®¶æ™‚æœŸç¬¦åˆæ™‚è§¸ç™¼ */
        .card.match-highlight { border: 4px solid var(--gold); background: #fffde7; transform: scale(1.02); box-shadow: 0 0 15px rgba(241, 196, 15, 0.4); }
        
        .score-tag { font-weight: bold; color: var(--red); font-size: 15px; margin-bottom: 4px; }
        .res-req { font-size: 12px; color: #666; margin: 5px 0; }
        .btn-buy { background: var(--green); color: white; border: none; padding: 8px; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 5px; }
        
        /* æ’åèˆ‡çµæŸ */
        .rank-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; }
        .btn-roll { background: var(--accent); color: white; border: none; padding: 15px; width: 100%; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-roll:disabled { background: #ccc; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-info">
        <span>ğŸ“… ç¬¬ <span id="round-num">1</span> / 5 å›åˆ</span>
        <span>ğŸ‘¤ ç©å®¶ <span id="player-label">1</span> / 10</span>
    </div>

    <div id="panel-main" class="panel">
        <div class="player-card">
            <h2 id="display-job" style="margin:0; color:var(--main);">--</h2>
            <div class="secret-area">
                <button onmousedown="showSecret(true)" onmouseup="showSecret(false)" ontouchstart="showSecret(true)" ontouchend="showSecret(false)" style="cursor:pointer; padding:5px 12px; border-radius:5px; border:1px solid #ccc;">ğŸ” é•·æŒ‰ç¢ºèªæˆ‘çš„æ™‚æœŸ</button>
                <div id="secret-info" class="secret-text">---</div>
            </div>
            <div style="font-size: 13px;">æˆ‘çš„å¤©è³¦ï¼š<b id="display-talent" style="color:var(--accent)">--</b> (+1ä¿åº•)</div>
        </div>

        <button id="roll-btn" class="btn-roll" onclick="rollDice()">ğŸ² æ“²éª°å­</button>
        <div class="dice-display" id="dice-container"></div>
        <div id="res-list" style="text-align:center; font-weight:bold; margin: 8px 0; color:var(--main);">è³‡æºï¼šç­‰å¾…æ“²éª°...</div>
        <div id="miracle-hint" style="text-align:center; color:var(--gold); font-size:12px; font-weight:bold; height:15px;"></div>

        <h3 style="font-size: 16px; border-left: 5px solid var(--main); padding-left: 10px; margin: 15px 0 10px 0;">äººç”Ÿé¸æ“‡ (é»ƒæ¡†è¡¨ç¤ºé©åˆä½ )</h3>
        <div class="market" id="market-container"></div>
        
        <button onclick="switchView()" style="margin-top:20px; width:100%; padding:10px; background:#7f8c8d; color:white; border:none; border-radius:8px; cursor:pointer;">ğŸ‘ï¸ æŸ¥çœ‹ç›®å‰æ’å</button>
    </div>

    <div id="panel-over" class="panel" style="display:none; text-align: center;">
        <h1 style="color:var(--gold)">ğŸ† æœ€çµ‚æ’å ğŸ†</h1>
        <div id="final-list"></div>
        <button onclick="location.reload()" style="margin-top:20px; padding:15px 30px; background:var(--main); color:white; border:none; border-radius:10px; font-weight:bold;">é‡æ–°é–‹å§‹æ–°äººç”Ÿ</button>
    </div>
</div>

<script>
    const diceFaces = [
        { n: 'äººéš›', c: '#e67e22', i: 'ğŸ¤' }, { n: 'é‡‘éŒ¢', c: '#f1c40f', i: 'ğŸ’°' },
        { n: 'æ™ºæ…§', c: '#3498db', i: 'ğŸ’¡' }, { n: 'ç¬‘è‡‰', c: '#2ecc71', i: 'ğŸ˜Š' },
        { n: 'å“­è‡‰', c: '#e74c3c', i: 'ğŸ’€' }, { n: 'å¥åº·', c: '#9b59b6', i: 'ğŸ¥' }
    ];

    const periods = ["å¹¼å¹´æœŸ", "å…¥å­¸æœŸ", "é’æ˜¥æœŸ", "åŒ—æ¼‚æœŸ", "æˆå®¶æœŸ", "å£¯å¹´æœŸ", "å±æ©ŸæœŸ", "å›ç”˜æœŸ", "éš±å±…æœŸ", "å‚³å¥‡æœŸ"];
    
    // --- å¡ç‰Œå…¬å¹³æ€§è¨­è¨ˆ ---
    // +6åˆ†ç‰Œï¼šæ¯å¼µè¦†è“‹2å€‹æ™‚æœŸï¼Œå…±5å¼µï¼Œç¢ºä¿æ¯å€‹æ™‚æœŸéƒ½æœ‰ä¸€æ¬¡+6æ©Ÿæœƒ
    const cardsLvl6 = [
        {n:'å¤©æ‰ç¥ç«¥', t:'æ™ºæ…§', q:2, lv:6, tg:[periods[0], periods[1]]},
        {n:'æ ¡éšŠæ˜æ˜Ÿ', t:'å¥åº·', q:2, lv:6, tg:[periods[2], periods[3]]},
        {n:'å‰µæ¥­æˆåŠŸ', t:'é‡‘éŒ¢', q:3, lv:6, tg:[periods[4], periods[5]]},
        {n:'ç¤¾æœƒè³¢é”', t:'äººéš›', q:3, lv:6, tg:[periods[6], periods[7]]},
        {n:'ç™¾æ­²å‚³å¥‡', t:'å¥åº·', q:3, lv:6, tg:[periods[8], periods[9]]}
    ];

    // +4åˆ†ç‰Œï¼šæ¯å¼µè¦†è“‹5å€‹æ™‚æœŸï¼Œå…±2å¼µï¼Œç¢ºä¿æ¯å€‹æ™‚æœŸéƒ½æœ‰ä¸€æ¬¡+4æ©Ÿæœƒ
    const cardsLvl4 = [
        {n:'å°ˆæ¥­è­‰ç…§', t:'æ™ºæ…§', q:2, lv:4, tg: periods.slice(0, 5)},
        {n:'ç’°éŠä¸–ç•Œ', t:'ç¬‘è‡‰', q:2, lv:4, tg: periods.slice(5, 10)}
    ];

    // +2åˆ†ç‰Œï¼šé€šç”¨
    const cardsLvl2 = [
        {n:'æ¯æ—¥æ…¢è·‘', t:'å¥åº·', q:1, lv:2, tg: []},
        {n:'é–±è®€ç¿’æ…£', t:'æ™ºæ…§', q:1, lv:2, tg: []},
        {n:'çµäº¤å¥½å‹', t:'äººéš›', q:1, lv:2, tg: []},
        {n:'åŠªåŠ›å„²è“„', t:'é‡‘éŒ¢', q:1, lv:2, tg: []}
    ];

    let players = [];
    let curIdx = 0;
    let curRound = 1;
    let curRes = {};
    let hasMiracle = false;
    let marketCards = [];

    function initGame() {
        let shufP = [...periods].sort(() => .5 - Math.random());
        players = Array.from({length:10}, (_, i) => ({
            id: i+1, job: ["é†«ç”Ÿ","é§­å®¢","ç•«å®¶","åµæ¢","å»šå¸«","æ©Ÿå¸«","è¾²å¤«","è©©äºº","å°éŠ","å¤ªç©ºäºº"][i],
            secret: shufP[i], talent: ['é‡‘éŒ¢','æ™ºæ…§','äººéš›','ç¬‘è‡‰'][Math.floor(Math.random()*4)],
            score: 0
        }));
        curIdx = 0; curRound = 1; refreshMarket();
        updateUI();
    }

    function refreshMarket() {
        // æ¯æ¬¡é‡æ–°æŠ½ç‰Œï¼š2å¼µ+6ï¼Œ2å¼µ+4ï¼Œ2å¼µ+2ï¼Œç¢ºä¿å•†åº—è±å¯Œ
        marketCards = [
            ...[...cardsLvl6].sort(()=>.5-Math.random()).slice(0,2),
            ...[...cardsLvl4].sort(()=>.5-Math.random()).slice(0,2),
            ...[...cardsLvl2].sort(()=>.5-Math.random()).slice(0,2)
        ].sort(()=>.5-Math.random());
    }

    function updateUI() {
        const p = players[curIdx];
        document.getElementById('round-num').innerText = curRound;
        document.getElementById('player-label').innerText = curIdx + 1;
        document.getElementById('display-job').innerText = p.job;
        document.getElementById('display-talent').innerText = p.talent;
        renderMarket();
    }

    function renderMarket() {
        const p = players[curIdx];
        document.getElementById('market-container').innerHTML = marketCards.map(c => {
            const isMatch = c.tg.includes(p.secret);
            return `
                <div class="card ${isMatch ? 'match-highlight' : ''}">
                    <div>
                        <div class="score-tag">${isMatch ? '+'+c.lv : '+2'} åˆ†</div>
                        <b style="font-size:15px;">${c.n}</b>
                        <div class="res-req">éœ€æ±‚ï¼š${c.q}å€‹${c.t}</div>
                    </div>
                    <button class="btn-buy" onclick="buyCard('${c.n}', '${c.t}', ${c.q}, ${c.lv}, '${c.tg.join(',')}')">è³¼è²·</button>
                </div>
            `;
        }).join('');
    }

    function showSecret(show) {
        const info = document.getElementById('secret-info');
        info.style.display = show ? 'block' : 'none';
        info.innerText = players[curIdx].secret;
    }

    function rollDice() {
        const p = players[curIdx];
        let cries = 0, smiles = 0;
        curRes = { 'äººéš›':0, 'é‡‘éŒ¢':0, 'æ™ºæ…§':0, 'ç¬‘è‡‰':0, 'å¥åº·':0 };
        curRes[p.talent] = 1;
        if(p.talent === 'ç¬‘è‡‰') smiles = 1;

        let html = "";
        for(let i=0; i<4; i++) {
            let r = diceFaces[Math.floor(Math.random()*6)];
            if(r.n==='å“­è‡‰') cries++;
            else { curRes[r.n]++; if(r.n==='ç¬‘è‡‰') smiles++; }
            html += `<div class="dice" style="background:${r.c}">${r.i}<br>${r.n}</div>`;
        }
        document.getElementById('dice-container').innerHTML = html;
        if(cries >= 3) { alert("ğŸ’€ å“­è‡‰éå¤šï¼å¤±å»è¡Œå‹•æ©Ÿæœƒã€‚"); nextPlayer(); }
        else {
            hasMiracle = (smiles >= 3);
            document.getElementById('miracle-hint').innerText = hasMiracle ? "ğŸŒŸ å¥‡è¹Ÿé”æˆï¼šæœ¬å›åˆå…è²»ä»»é¸ä¸€å¡ï¼" : "";
            document.getElementById('roll-btn').disabled = true;
            renderRes(); checkAutoNext();
        }
    }

    function renderRes() {
        let txt = Object.entries(curRes).filter(([k,v])=>v>0).map(([k,v])=>`${k}x${v}`).join(' / ');
        document.getElementById('res-list').innerText = "è³‡æºï¼š" + (txt || "ç„¡");
    }

    function buyCard(name, resType, qty, baseLv, targets) {
        const p = players[curIdx];
        const tgArray = targets ? targets.split(',') : [];
        let canBuy = hasMiracle;
        if (!canBuy && curRes[resType] >= qty) { curRes[resType] -= qty; canBuy = true; }

        if (canBuy) {
            let gain = tgArray.includes(p.secret) ? baseLv : 2;
            p.score += gain;
            hasMiracle = false;
            document.getElementById('miracle-hint').innerText = "";
            alert(`âœ… è³¼è²·ã€Œ${name}ã€æˆåŠŸï¼ç©åˆ† +${gain}`);
            renderRes(); checkAutoNext();
        } else alert("âŒ è³‡æºä¸è¶³ï¼");
    }

    function checkAutoNext() {
        if(hasMiracle) return;
        if(!marketCards.some(c => curRes[c.t] >= c.q)) {
            setTimeout(() => { alert("ğŸ“¢ ç„¡æ³•ç¹¼çºŒè³¼è²·ï¼Œæ›´æ›ä¸‹ä¸€ä½ç©å®¶ã€‚"); nextPlayer(); }, 600);
        }
    }

    function nextPlayer() {
        curIdx++;
        if(curIdx >= 10) {
            curIdx = 0; curRound++;
            if(curRound > 5) return endGame();
            alert(`ğŸ“… ç¬¬ ${curRound} å›åˆé–‹å§‹ï¼`);
        }
        curRes = {}; hasMiracle = false;
        document.getElementById('roll-btn').disabled = false;
        document.getElementById('dice-container').innerHTML = "";
        document.getElementById('res-list').innerText = "è³‡æºï¼šç­‰å¾…æ“²éª°...";
        document.getElementById('miracle-hint').innerText = "";
        refreshMarket(); updateUI();
        window.scrollTo(0,0);
    }

    function switchView() {
        const sorted = [...players].sort((a,b)=>b.score - a.score);
        let list = sorted.map((p, i) => `<div class="rank-item"><span>${i+1}. ${p.job}</span><b>${p.score} åˆ†</b></div>`).join('');
        alert("ç›®å‰æ’åï¼š\n" + sorted.map((p,i)=>`${i+1}. ${p.job}: ${p.score}åˆ†`).join('\n'));
    }

    function endGame() {
        document.getElementById('panel-main').style.display = 'none';
        document.getElementById('panel-over').style.display = 'block';
        const sorted = [...players].sort((a,b)=>b.score - a.score);
        document.getElementById('final-list').innerHTML = sorted.map((p, i) => `
            <div class="rank-item" style="${i===0?'font-size:20px; color:var(--red); font-weight:bold;':''}">
                <span>${i+1}. ${p.job} (${p.secret})</span>
                <b>${p.score} åˆ†</b>
            </div>
        `).join('');
    }

    initGame();
</script>
</body>
</html>