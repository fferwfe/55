<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CV äººç”Ÿå±¥æ­· - è³‡æºç¸½è¨ˆç‰ˆ</title>
    <style>
        :root { --main: #2c3e50; --accent: #e67e22; --bg: #f5f7fa; --green: #27ae60; --red: #e74c3c; --white: #ffffff; --blue: #3498db; --gold: #f1c40f; }
        body { font-family: 'PingFang TC', sans-serif; background: var(--bg); margin: 0; padding: 10px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 500px; }
        .header-info { display: flex; justify-content: space-between; background: var(--main); color: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; font-weight: bold; font-size: 14px; }
        .panel { background: var(--white); padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .player-card { text-align: center; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 15px; }
        .rule-box { background: #fffde7; border: 1px solid var(--gold); padding: 10px; border-radius: 8px; font-size: 13px; color: #7f8c8d; margin-top: 10px; }
        .dice-display { display: flex; justify-content: center; gap: 6px; margin: 10px 0; min-height: 60px; }
        .dice { width: 55px; height: 55px; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.65rem; text-align: center; }
        .res-summary { text-align:center; font-weight:bold; margin: 8px 0; color: var(--main); background: #edf2f7; padding: 8px; border-radius: 5px; }
        .market { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .card { border: 2px solid #eee; padding: 10px; border-radius: 12px; text-align: center; display: flex; flex-direction: column; justify-content: space-between; min-height: 130px; }
        .tag-row { display: flex; justify-content: center; gap: 4px; margin-top: 5px; }
        .res-tag { font-size: 10px; padding: 2px 4px; border-radius: 3px; background: #eee; color: #666; }
        .btn-buy { background: var(--green); color: white; border: none; padding: 8px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 5px; }
        .btn-roll { background: var(--accent); color: white; border: none; padding: 15px; width: 100%; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        #event-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); color: white; z-index: 100; flex-direction: column; align-items: center; justify-content: center; padding: 30px; text-align: center; }
    </style>
</head>
<body>

<div id="event-overlay">
    <h1 id="event-title" style="color:var(--red)">ğŸš¨ å‘½é‹äº‹ä»¶</h1>
    <p id="event-desc" style="font-size: 20px; margin: 20px 0; line-height: 1.5;"></p>
    <button onclick="closeEvent()" style="padding: 12px 40px; border-radius: 8px; border: none; background: var(--green); color: white; font-weight: bold; font-size: 16px;">å®Œæˆä¸¦ç¹¼çºŒ</button>
</div>

<div class="container">
    <div class="header-info">
        <span>ğŸ“… ç¬¬ <span id="round-num">1</span> / 5 å›åˆ</span>
        <span>ğŸ‘¤ ç©å®¶ <span id="player-label">1</span> / 10</span>
    </div>

    <div id="panel-main" class="panel">
        <div class="player-card">
            <h2 id="display-job" style="margin:0; color:var(--main);">--</h2>
            <div id="display-rule" class="rule-box">--</div>
            <div style="margin-top:10px; font-size: 14px;">ç•¶å‰ç´¯è¨ˆåˆ†æ•¸ï¼š<b id="cur-score" style="color:var(--red); font-size: 1.2rem;">0</b></div>
        </div>

        <button id="roll-btn" class="btn-roll" onclick="rollDice()">ğŸ² æ“²éª°å­</button>
        <div class="dice-display" id="dice-container"></div>
        <div class="res-summary" id="res-list">ç­‰å¾…æ“²éª°...</div>

        <h3 style="font-size: 15px; border-left: 5px solid var(--blue); padding-left: 10px; margin: 15px 0 10px 0;">æˆå°±å•†åº— (2å€‹è³‡æº3åˆ† / 1å€‹è³‡æº1åˆ†)</h3>
        <div class="market" id="market-container"></div>
    </div>

    <div id="panel-over" class="panel" style="display:none; text-align: center;">
        <h1 style="color:var(--gold)">ğŸ† äººç”Ÿçµç®—ï¼šç¸½è³‡æºè¨ˆåˆ†</h1>
        <div id="final-list"></div>
        <button onclick="location.reload()" class="btn-roll">é‡å•Ÿäººç”Ÿ</button>
    </div>
</div>

<script>
    const diceFaces = [
        { n: 'äººéš›', c: '#e67e22' }, { n: 'é‡‘éŒ¢', c: '#f1c40f' },
        { n: 'æ™ºæ…§', c: '#3498db' }, { n: 'å¥åº·', c: '#9b59b6' },
        { n: 'ç¬‘è‡‰', c: '#2ecc71' }, { n: 'å“­è‡‰', c: '#e74c3c' }
    ];

    // è¨ˆåˆ†å¤©è³¦ï¼šæœ€å¾Œæ ¹æ“šæˆå°±å¡ä¸Šçš„ã€Œæ¨™ç±¤ã€ä¾†åŠ æ¬Š
    const scoringRules = [
        { desc: "ã€å¯¦æ¥­å®¶ã€‘å¡ç‰‡æ¨™ç±¤å«æœ‰ã€Œé‡‘éŒ¢ã€å¾— 3 åˆ†ï¼Œå…¶é¤˜ 1 åˆ†", type: 'é‡‘éŒ¢' },
        { desc: "ã€æ€æƒ³å®¶ã€‘å¡ç‰‡æ¨™ç±¤å«æœ‰ã€Œæ™ºæ…§ã€å¾— 3 åˆ†ï¼Œå…¶é¤˜ 1 åˆ†", type: 'æ™ºæ…§' },
        { desc: "ã€äººè„ˆç‹ã€‘å¡ç‰‡æ¨™ç±¤å«æœ‰ã€Œäººéš›ã€å¾— 3 åˆ†ï¼Œå…¶é¤˜ 1 åˆ†", type: 'äººéš›' },
        { desc: "ã€å¥åº·å¤§ä½¿ã€‘å¡ç‰‡æ¨™ç±¤å«æœ‰ã€Œå¥åº·ã€å¾— 3 åˆ†ï¼Œå…¶é¤˜ 1 åˆ†", type: 'å¥åº·' }
    ];

    // å•†åº—å“é …ï¼šåš´æ ¼éµå®ˆ 2è³‡æº3åˆ† / 1è³‡æº1åˆ†
    const marketItems = [
        { n: 'å°ˆæ¥­è­‰ç…§', cost: 'æ™ºæ…§', q: 2, v: 3 },
        { n: 'è·¨åœ‹æ—…éŠ', cost: 'äººéš›', q: 2, v: 3 },
        { n: 'å¥èº«ç¿’æ…£', cost: 'å¥åº·', q: 2, v: 3 },
        { n: 'å‰µæ¥­å†’éšª', cost: 'é‡‘éŒ¢', q: 2, v: 3 },
        { n: 'æ—¥å¸¸å„²è“„', cost: 'é‡‘éŒ¢', q: 1, v: 1 },
        { n: 'é€±æœ«èšé¤', cost: 'äººéš›', q: 1, v: 1 },
        { n: 'ç¶­æŒå¥½å¿ƒæƒ…', cost: 'æ™ºæ…§', q: 1, v: 1 }
    ];

    let players = [], curIdx = 0, curRound = 1, turnRes = {};

    function initGame() {
        players = Array.from({length:10}, (_, i) => ({
            id: i+1, job: ["é†«ç”Ÿ","é§­å®¢","ç•«å®¶","åµæ¢","å»šå¸«","æ©Ÿå¸«","è¾²å¤«","è©©äºº","å°éŠ","å¤ªç©ºäºº"][i],
            cards: [], score: 0,
            rule: scoringRules[Math.floor(Math.random() * scoringRules.length)]
        }));
        updateUI();
    }

    function updateUI() {
        const p = players[curIdx];
        document.getElementById('round-num').innerText = curRound;
        document.getElementById('player-label').innerText = curIdx + 1;
        document.getElementById('display-job').innerText = p.job;
        document.getElementById('display-rule').innerText = "è¨ˆåˆ†å¤©è³¦ï¼š" + p.rule.desc;
        document.getElementById('cur-score').innerText = p.score;
        renderMarket();
    }

    function renderMarket() {
        document.getElementById('market-container').innerHTML = marketItems.map((c, idx) => `
            <div class="card">
                <div style="font-weight:bold; color:var(--red);">+${c.v} åˆ†</div>
                <b style="font-size:14px;">${c.n}</b>
                <div class="tag-row"><span class="res-tag">ğŸ·ï¸ ${c.cost}</span></div>
                <div style="font-size:11px; color:#666; margin: 5px 0;">éœ€: ${c.q} ${c.cost}</div>
                <button class="btn-buy" onclick="buyCard(${idx})">è³¼è²·æˆå°±</button>
            </div>`).join('');
    }

    function rollDice() {
        turnRes = { 'äººéš›':0, 'é‡‘éŒ¢':0, 'æ™ºæ…§':0, 'å¥åº·':0, 'ç¬‘è‡‰':0 };
        let cries = 0, diceHtml = "";
        for(let i=0; i<4; i++) {
            let r = diceFaces[Math.floor(Math.random()*6)];
            if(r.n === 'ç¬‘è‡‰') turnRes['ç¬‘è‡‰']++;
            else if(r.n === 'å“­è‡‰') cries++;
            else turnRes[r.n]++;
            diceHtml += `<div class="dice" style="background:${r.c}">${r.n === 'ç¬‘è‡‰' ? 'ğŸ˜Š' : (r.n === 'å“­è‡‰' ? 'ğŸ’€' : r.n)}</div>`;
        }
        document.getElementById('dice-container').innerHTML = diceHtml;
        document.getElementById('roll-btn').disabled = true;
        renderTurnRes();
        if (cries > 0) triggerFate(cries);
    }

    function triggerFate(count) {
        const overlay = document.getElementById('event-overlay');
        const desc = document.getElementById('event-desc');
        const title = document.getElementById('event-title');
        overlay.style.display = 'flex';

        if (count === 1) {
            title.innerText = "ğŸ² å‘½é‹ç‰¹æ®Šæ´»å‹•";
            const tasks = ["è·Ÿå·¦å³å…©é‚Šçš„ç©å®¶æ¡æ‰‹è‡´æ„", "ç«™èµ·ä¾†èª‡çä¸€ä½ç©å®¶çš„å„ªé»", "åŸåœ°é–‹åˆè·³ 3 ä¸‹", "åˆ†äº«ä¸€å€‹ä½ é€™è¼©å­æœ€é›£å¿˜çš„ç¬é–“"];
            desc.innerText = tasks[Math.floor(Math.random()*tasks.length)];
        } else {
            title.innerText = "ğŸ’€ è² é¢æ‡²ç½°äº‹ä»¶";
            const penalties = ["ã€è³‡æºå°å°ã€‘æœ¬å›åˆçš„æ‰€æœ‰ç¬‘è‡‰(è¬èƒ½è³‡æº)å¤±æ•ˆ", "ã€äººç”Ÿåœæ»¯ã€‘æœ¬å›åˆæ“²å‡ºçš„è³‡æºç›´æ¥æ¸›åŠ(ç„¡æ¢ä»¶æ¨å»)", "ã€æ„å¤–æ”¯å‡ºã€‘å¦‚æœä½ æœ¬å›åˆè³¼è²·å¡ç‰‡ï¼Œéœ€é¡å¤–å¤šæ”¯ä»˜ 1 å€‹ä»»æ„è³‡æº"];
            const pIdx = Math.floor(Math.random()*penalties.length);
            desc.innerText = penalties[pIdx];
            if(pIdx === 0) turnRes['ç¬‘è‡‰'] = 0;
            if(pIdx === 1) Object.keys(turnRes).forEach(k => turnRes[k] = Math.floor(turnRes[k]/2));
        }
        renderTurnRes();
    }

    function closeEvent() { document.getElementById('event-overlay').style.display = 'none'; checkTurnEnd(); }

    function buyCard(idx) {
        const c = marketItems[idx], p = players[curIdx];
        let total = turnRes[c.cost] + turnRes['ç¬‘è‡‰'];
        if (total >= c.q) {
            let fromNormal = Math.min(turnRes[c.cost], c.q);
            turnRes[c.cost] -= fromNormal;
            turnRes['ç¬‘è‡‰'] -= (c.q - fromNormal);
            // å­˜å…¥å¡ç‰‡ç´€éŒ„
            p.cards.push({...c});
            // è³¼è²·å³è¨ˆåˆ†
            p.score += c.v;
            renderTurnRes(); updateUI(); checkTurnEnd();
        } else alert("æœ¬å›åˆè³‡æºä¸è¶³ï¼");
    }

    function renderTurnRes() {
        let txt = Object.entries(turnRes).filter(([k,v])=>v>0).map(([k,v])=>`${k}x${v}`).join(' / ');
        document.getElementById('res-list').innerText = "å¯ç”¨è³‡æºï¼š" + (txt || "ç„¡");
    }

    function checkTurnEnd() {
        const canBuy = marketItems.some(c => (turnRes[c.cost] + turnRes['ç¬‘è‡‰']) >= c.q);
        if (!canBuy && document.getElementById('event-overlay').style.display === 'none') {
            setTimeout(() => { alert("è³‡æºè€—ç›¡ï¼Œåˆ‡æ›ç©å®¶ã€‚"); nextPlayer(); }, 1000);
        }
    }

    function nextPlayer() {
        curIdx++;
        if(curIdx >= 10) { curIdx = 0; curRound++; if(curRound > 5) return endGame(); }
        document.getElementById('roll-btn').disabled = false;
        document.getElementById('dice-container').innerHTML = "";
        document.getElementById('res-list').innerText = "ç­‰å¾…æ“²éª°...";
        updateUI();
    }

    function endGame() {
        document.getElementById('panel-main').style.display = 'none';
        document.getElementById('panel-over').style.display = 'block';
        
        // æœ€çµ‚ç¸½è³‡æºè¨ˆåˆ†ï¼šå¡ç‰‡ä¸Šçš„æ¨™ç±¤èˆ‡å¤©è³¦åŒ¹é…å‰‡å¾— 3 åˆ†ï¼Œä¸åŒ¹é…å‰‡ 1 åˆ†
        let results = players.map(p => {
            let finalScore = p.cards.reduce((sum, card) => sum + (card.cost === p.rule.type ? 3 : 1), 0);
            return { job: p.job, score: finalScore, rule: p.rule.desc, count: p.cards.length };
        }).sort((a,b) => b.score - a.score);

        document.getElementById('final-list').innerHTML = results.map((r, i) => `
            <div style="padding:15px; border-bottom:1px solid #eee; text-align:left;">
                <b>${i+1}. ${r.job}</b> <small style="color:#999">(${r.count} å¼µæˆå°±)</small><br>
                <small>${r.rule}</small>
                <div style="color:var(--red); font-weight:bold; font-size:1.4rem;">ç¸½åˆ†ï¼š${r.score} åˆ†</div>
            </div>`).join('');
    }
    initGame();
</script>
</body>
</html>
