<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CV äººç”Ÿå±¥æ­· - éšæ¢¯ç·šæ€§æˆé•·ç‰ˆ</title>
    <style>
        :root { --main: #2c3e50; --accent: #e67e22; --bg: #f5f7fa; --green: #27ae60; --red: #e74c3c; --blue: #3498db; --gold: #f1c40f; }
        body { font-family: 'PingFang TC', sans-serif; background: var(--bg); margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 500px; position: relative; }
        #alert-msg { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--main); color: white; padding: 10px 20px; border-radius: 20px; font-weight: bold; z-index: 1000; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .header-info { display: flex; justify-content: space-between; background: var(--main); color: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; font-weight: bold; }
        .panel { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .tabs { display: flex; gap: 5px; margin-bottom: 10px; }
        .tab-btn { flex: 1; padding: 8px; border: none; background: #ddd; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .tab-btn.active { background: var(--blue); color: white; }
        .rule-box { background: #fffde7; border: 1px solid var(--gold); padding: 8px; border-radius: 8px; font-size: 13px; color: #555; font-weight: bold; text-align: center; }
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 10px 0; }
        .btn { padding: 15px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; color: white; font-size: 16px; }
        .btn-roll { background: var(--accent); }
        .btn-end { background: var(--main); }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .dice-display { display: flex; justify-content: center; gap: 6px; margin: 10px 0; height: 50px; }
        .dice { width: 45px; height: 45px; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.7rem; }
        .res-summary { text-align:center; font-weight:bold; margin-bottom: 15px; color: var(--main); background: #edf2f7; padding: 10px; border-radius: 5px; }
        .market { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .card { border: 1px solid #eee; padding: 10px; border-radius: 10px; display: flex; flex-direction: column; justify-content: space-between; min-height: 150px; background: #fafafa; }
        .res-tag { display: inline-block; padding: 1px 3px; border-radius: 3px; margin: 1px; color: white; font-size: 9px; }
        .btn-buy { background: var(--green); color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer; font-weight: bold; margin-top: 5px; }
        .score-card { text-align: left; padding: 15px; border-bottom: 2px solid #eee; }
        .score-pill { display: inline-block; background: #eee; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-right: 5px; margin-top: 3px; }
    </style>
</head>
<body>

<div id="alert-msg"></div>

<div class="container">
    <div class="header-info">
        <span>ğŸ“… ç¬¬ <span id="round-num">1</span> / 5 è¼ª</span>
        <span>ğŸ‘¤ ç©å®¶ <span id="player-label">1</span> / 10</span>
    </div>

    <div class="tabs">
        <button id="tab-game" class="tab-btn active" onclick="switchTab('game')">ç•¶å‰è¡Œå‹•</button>
        <button id="tab-others" class="tab-btn" onclick="switchTab('others')">æŸ¥çœ‹å°æ‰‹</button>
    </div>

    <div id="panel-game" class="panel">
        <div id="display-job" style="text-align:center; font-weight:bold; font-size:1.2rem; color:var(--main);">è¼‰å…¥ä¸­...</div>
        <div id="display-rule" class="rule-box" style="margin: 10px 0;">--</div>
        <div style="font-size:12px; text-align:center;">ç´¯ç©è³‡ç”¢ï¼š<span id="my-tags" style="color:var(--blue); font-weight:bold;">ç„¡</span></div>

        <div class="controls">
            <button id="roll-btn" class="btn btn-roll" onclick="rollDice()">ğŸ² æ“²éª°å­</button>
            <button id="end-btn" class="btn btn-end" onclick="nextPlayer()" disabled>ğŸ çµæŸå›åˆ</button>
        </div>

        <div class="dice-display" id="dice-container"></div>
        <div id="res-list" class="res-summary">è«‹å…ˆæ“²éª°å­ç²å–è³‡æº</div>

        <div class="market" id="market-container"></div>
    </div>

    <div id="panel-others" class="panel" style="display:none;">
        <h3 style="margin-top:0;">å„ç©å®¶å³æ™‚è³‡ç”¢</h3>
        <div id="other-players-list-content"></div>
    </div>

    <div id="panel-over" class="panel" style="display:none; text-align: center;">
        <h1 style="color:var(--gold)">ğŸ† äººç”Ÿæˆå°±çµç®—</h1>
        <div id="final-list"></div>
        <button onclick="location.reload()" class="btn btn-roll" style="width:100%; margin-top:20px;">é‡å•Ÿäººç”Ÿ</button>
    </div>
</div>

<script>
    const resColor = { 'é‡‘éŒ¢': '#f1c40f', 'æ™ºæ…§': '#3498db', 'äººéš›': '#e67e22', 'å¥åº·': '#9b59b6', 'ç¬‘è‡‰': '#2ecc71' };
    const fullCardPool = [
        { n: 'çŸ½è°·å‰µæ¥­', cost: { 'æ™ºæ…§':2, 'äººéš›':1 }, gains: { 'é‡‘éŒ¢':4 } },
        { n: 'ç’°çƒæ—…è¡Œ', cost: { 'é‡‘éŒ¢':2 }, gains: { 'äººéš›':2, 'å¥åº·':1 } },
        { n: 'é†«å­¸é™¢', cost: { 'æ™ºæ…§':3 }, gains: { 'æ™ºæ…§':2, 'å¥åº·':2 } },
        { n: 'å¥§é‹è¨“ç·´', cost: { 'å¥åº·':3 }, gains: { 'å¥åº·':2, 'äººéš›':1 } },
        { n: 'æ•¸ä½è¡ŒéŠ·', cost: { 'äººéš›':2 }, gains: { 'é‡‘éŒ¢':2, 'æ™ºæ…§':1 } },
        { n: 'ç‘œçˆå†¥æƒ³', cost: { 'æ™ºæ…§':1, 'å¥åº·':1 }, gains: { 'å¥åº·':2, 'æ™ºæ…§':1 } },
        { n: 'è‚¡å¸‚é”äºº', cost: { 'é‡‘éŒ¢':2, 'æ™ºæ…§':1 }, gains: { 'é‡‘éŒ¢':3 } },
        { n: 'æ¥µé™é‹å‹•', cost: { 'å¥åº·':3 }, gains: { 'å¥åº·':1, 'æ™ºæ…§':2, 'äººéš›':2 } },
        { n: 'è·¨åœ‹ä½µè³¼', cost: { 'é‡‘éŒ¢':3, 'äººéš›':1 }, gains: { 'é‡‘éŒ¢':4, 'äººéš›':1 } },
        { n: 'æ…ˆå–„åŸºé‡‘', cost: { 'äººéš›':3 }, gains: { 'äººéš›':2, 'æ™ºæ…§':2 } }
    ];

    const scoringRules = [
        { name: "æ™ºæ…§ï¼šé‡‘éŒ¢", pair: ['æ™ºæ…§', 'é‡‘éŒ¢'] },
        { name: "äººéš›ï¼šé‡‘éŒ¢", pair: ['äººéš›', 'é‡‘éŒ¢'] },
        { name: "å¥åº·ï¼šäººéš›", pair: ['å¥åº·', 'äººéš›'] },
        { name: "æ™ºæ…§ï¼šå¥åº·", pair: ['æ™ºæ…§', 'å¥åº·'] }
    ];

    let players = [], curIdx = 0, curRound = 1, turnRes = {}, hasRolled = false, currentMarket = [];

    function initGame() {
        players = Array.from({length:10}, (_, i) => ({
            id: i+1, job: ["é†«ç”Ÿ","å·¥ç¨‹å¸«","ç•«å®¶","åµæ¢","å»šå¸«","æ©Ÿå¸«","è¾²å¤«","è©©äºº","å°éŠ","å¤ªç©ºäºº"][i],
            allTags: { 'é‡‘éŒ¢':0, 'æ™ºæ…§':0, 'äººéš›':0, 'å¥åº·':0 },
            rule: scoringRules[Math.floor(Math.random() * scoringRules.length)]
        }));
        refreshMarket(); updateUI();
    }

    function refreshMarket() {
        currentMarket = [...fullCardPool].sort(() => 0.5 - Math.random()).slice(0, 6);
    }

    function updateUI() {
        const p = players[curIdx];
        document.getElementById('player-label').innerText = p.id;
        document.getElementById('round-num').innerText = curRound;
        document.getElementById('display-job').innerText = p.job;
        document.getElementById('display-rule').innerText = `ç›®æ¨™(${p.rule.name}):3åˆ† / 5-6å€‹:6åˆ† / ä¹‹å¾Œ+1`;
        let tagTxt = Object.entries(p.allTags).filter(([k,v])=>v>0).map(([k,v])=>`${k}x${v}`).join(' / ');
        document.getElementById('my-tags').innerText = tagTxt || "ç„¡";
        renderMarket();
    }

    function renderMarket() {
        document.getElementById('market-container').innerHTML = currentMarket.map((c, idx) => {
            let costH = Object.entries(c.cost).map(([k,v])=>`<span class="res-tag" style="background:${resColor[k]}">${k}x${v}</span>`).join('');
            let gainH = Object.entries(c.gains).map(([k,v])=>`<span class="res-tag" style="background:${resColor[k]}">${k}x${v}</span>`).join('');
            return `<div class="card"><b>${c.n}</b><div style="font-size:10px; background:#ffebeb; padding:2px; margin:2px 0;">ä»˜ï¼š${costH}</div><div style="font-size:10px; background:#ebffeb; padding:2px; margin:2px 0;">å¾—ï¼š${gainH}</div>
                <button class="btn-buy" onclick="buyCard(${idx})" ${!hasRolled?'disabled':''}>ç¢ºèªå…Œæ›</button></div>`;
        }).join('');
    }

    function rollDice() {
        turnRes = { 'é‡‘éŒ¢':0, 'æ™ºæ…§':0, 'äººéš›':0, 'å¥åº·':0, 'ç¬‘è‡‰':0 };
        for(let i=0; i<6; i++) {
            let r = Object.keys(resColor)[Math.floor(Math.random()*5)];
            turnRes[r]++;
        }
        hasRolled = true; document.getElementById('roll-btn').disabled = true; document.getElementById('end-btn').disabled = false;
        renderTurnRes(); renderMarket();
    }

    function buyCard(idx) {
        const c = currentMarket[idx], p = players[curIdx];
        let tempSmile = turnRes['ç¬‘è‡‰'], canAfford = true;
        for (let [res, amt] of Object.entries(c.cost)) {
            let gap = amt - turnRes[res];
            if (gap > 0) { if (tempSmile >= gap) tempSmile -= gap; else { canAfford = false; break; } }
        }
        if (canAfford) {
            for (let [res, amt] of Object.entries(c.cost)) {
                let gap = amt - turnRes[res];
                if (gap > 0) { turnRes['ç¬‘è‡‰'] -= gap; turnRes[res] = 0; } else { turnRes[res] -= amt; }
            }
            for (let [res, amt] of Object.entries(c.gains)) { p.allTags[res] += amt; }
            renderTurnRes(); updateUI();
        } else if (turnRes['ç¬‘è‡‰'] >= 3) {
            if (confirm("æ¶ˆè€— 3 å€‹ğŸ˜Šç¬‘è‡‰å¼·è¡Œæ›å–é€™å¼µå¡ç‰‡ï¼Ÿ")) { 
                turnRes['ç¬‘è‡‰'] -= 3; for (let [res, amt] of Object.entries(c.gains)) { p.allTags[res] += amt; } 
                renderTurnRes(); updateUI(); 
            }
        } else { showNotify("âŒ è³‡æºä¸è¶³ï¼"); }
    }

    function nextPlayer() {
        curIdx++;
        if(curIdx >= 10) { curIdx = 0; curRound++; if(curRound > 5) return endGame(); refreshMarket(); }
        hasRolled = false; document.getElementById('roll-btn').disabled = false; document.getElementById('end-btn').disabled = true;
        switchTab('game'); updateUI();
    }

    function showNotify(msg) {
        const el = document.getElementById('alert-msg');
        el.innerText = msg; el.style.display = 'block'; setTimeout(() => el.style.display = 'none', 2000);
    }

    function renderTurnRes() {
        let txt = Object.entries(turnRes).filter(([k,v])=>v>0).map(([k,v])=>`${k}x${v}`).join(' / ');
        document.getElementById('res-list').innerText = "å¯ç”¨è³‡æºï¼š" + (txt || "å·²ç”¨ç›¡");
    }

    function switchTab(tab) {
        document.getElementById('panel-game').style.display = tab === 'game' ? 'block' : 'none';
        document.getElementById('panel-others').style.display = tab === 'others' ? 'block' : 'none';
        if(tab === 'others') {
            document.getElementById('other-players-list-content').innerHTML = players.map(p => {
                let tags = Object.entries(p.allTags).filter(([k,v])=>v>0).map(([k,v])=>`${k}${v}`).join(', ');
                return `<div style="padding:10px; border-bottom:1px solid #eee;"><b>ç©å®¶${p.id} (${p.job})</b><br><span style="color:var(--blue);font-size:12px;">${tags || 'ç„¡è³‡ç”¢'}</span></div>`;
            }).join('');
        }
    }

    // å¯¦ä½œæ‚¨è¦æ±‚çš„è¨ˆåˆ†é‚è¼¯
    function getStepScore(count) {
        if (count <= 0) return 0;
        if (count <= 2) return 2;
        if (count <= 4) return 4;
        if (count <= 6) return 6;
        // 7 å€‹ä»¥ä¸Šï¼Œæ¯å¤šä¸€å€‹åŠ  1 åˆ†
        return 6 + (count - 6); 
    }

    function endGame() {
        document.getElementById('panel-game').style.display = 'none';
        document.getElementById('panel-over').style.display = 'block';
        document.querySelector('.tabs').style.display = 'none';

        let results = players.map(p => {
            let t = {...p.allTags};
            let pairCount = Math.min(t[p.rule.pair[0]], t[p.rule.pair[1]]);
            let pairScore = pairCount * 3;
            t[p.rule.pair[0]] -= pairCount;
            t[p.rule.pair[1]] -= pairCount;
            
            let resScores = {};
            let stepTotal = 0;
            for(let k in t) {
                let s = getStepScore(t[k]);
                resScores[k] = { count: t[k], score: s };
                stepTotal += s;
            }
            return { job: p.job, rule: p.rule.name, pairCount, pairScore, stepTotal, resScores, total: pairScore + stepTotal };
        }).sort((a,b) => b.total - a.total);

        document.getElementById('final-list').innerHTML = results.map((r, i) => `
            <div class="score-card">
                <b>${i+1}. ${r.job}</b> <small>(${r.rule})</small>
                <div style="font-size:11px; margin:5px 0;">
                    âœ¨ ç›®æ¨™é…å°ï¼š${r.pairCount}çµ„ â†’ <b>${r.pairScore}åˆ†</b><br>
                    ğŸ“¦ å‰©é¤˜éšæ¢¯ï¼š${Object.entries(r.resScores).filter(e=>e[1].count>0).map(e=>`<span class="score-pill">${e[0]}${e[1].count}â†’${e[1].score}åˆ†</span>`).join('')}
                </div>
                <div style="color:var(--red); font-weight:bold; font-size:1.3rem;">æœ€çµ‚åƒ¹å€¼ï¼š${r.total} åˆ†</div>
            </div>`).join('');
    }
    initGame();
</script>
</body>
</html>
