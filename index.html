<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CV äººç”Ÿå±¥æ­· - è¤‡åˆæŠ•è³‡ç‰ˆ</title>
    <style>
        :root { --main: #2c3e50; --accent: #e67e22; --bg: #f5f7fa; --green: #27ae60; --red: #e74c3c; --white: #ffffff; --blue: #3498db; --gold: #f1c40f; --purple: #9b59b6; }
        body { font-family: 'PingFang TC', sans-serif; background: var(--bg); margin: 0; padding: 10px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 550px; }
        .header-info { display: flex; justify-content: space-between; background: var(--main); color: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; font-weight: bold; font-size: 14px; }
        .panel { background: var(--white); padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .player-card { text-align: center; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 15px; }
        .rule-box { background: #fffde7; border: 1px solid var(--gold); padding: 8px; border-radius: 8px; font-size: 13px; color: #7f8c8d; margin-top: 8px; font-weight: bold; }
        .dice-display { display: flex; justify-content: center; gap: 6px; margin: 10px 0; min-height: 60px; }
        .dice { width: 55px; height: 55px; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.65rem; }
        .res-summary { text-align:center; font-weight:bold; margin: 8px 0; color: var(--main); background: #edf2f7; padding: 8px; border-radius: 5px; }
        
        .market { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .card { border: 2px solid #eee; padding: 10px; border-radius: 12px; text-align: center; display: flex; flex-direction: column; justify-content: space-between; min-height: 160px; background: white; transition: 0.2s; }
        .card:hover { border-color: var(--blue); }
        
        .section-title { font-size: 10px; color: #999; margin-bottom: 2px; }
        .cost-area { background: #fff5f5; border-radius: 5px; padding: 5px; margin-bottom: 8px; border: 1px solid #fed7d7; }
        .gain-area { background: #f0fff4; border-radius: 5px; padding: 5px; margin-bottom: 8px; border: 1px solid #c6f6d5; }
        .res-mini { display: inline-block; font-size: 10px; padding: 1px 4px; border-radius: 3px; margin: 1px; color: white; }
        
        .btn-buy { background: var(--main); color: white; border: none; padding: 8px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; }
        .btn-roll { background: var(--accent); color: white; border: none; padding: 15px; width: 100%; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        
        #event-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); color: white; z-index: 100; flex-direction: column; align-items: center; justify-content: center; padding: 30px; text-align: center; }
        .inventory-list { display: flex; flex-wrap: wrap; justify-content: center; gap: 4px; margin-top: 5px; }
        .inv-tag { background: #e2e8f0; font-size: 10px; padding: 2px 5px; border-radius: 3px; }
    </style>
</head>
<body>

<div id="event-overlay">
    <h1 id="event-title">ğŸš¨ å‘½é‹äº‹ä»¶</h1>
    <p id="event-desc" style="font-size: 20px; margin: 20px 0;"></p>
    <button onclick="closeEvent()" style="padding: 12px 40px; border-radius: 8px; border: none; background: var(--gold); color: black; font-weight: bold;">åŸ·è¡Œä»»å‹™</button>
</div>

<div class="container">
    <div class="header-info">
        <span>ğŸ“… ç¬¬ <span id="round-num">1</span> / 5 å›åˆ</span>
        <span>ğŸ‘¤ ç©å®¶ <span id="player-label">1</span> / 10</span>
    </div>

    <div id="panel-main" class="panel">
        <div class="player-card">
            <h2 id="display-job" style="margin:0; color:var(--main);">--</h2>
            <div id="display-rule" class="rule-box">--</div>
            <div class="inventory-list" id="inv-container"></div>
        </div>

        <button id="roll-btn" class="btn-roll" onclick="rollDice()">ğŸ² æ“²éª°å­ç²å–è³‡æº</button>
        <div class="dice-display" id="dice-container"></div>
        <div class="res-summary" id="res-list">å¯ç”¨è³‡æºï¼šç­‰å¾…ä¸­...</div>

        <h3 style="font-size: 14px; border-left: 5px solid var(--blue); padding-left: 10px; margin: 15px 0 10px 0;">æˆå°±å•†åº— (è¤‡åˆè³‡æºäº¤æ›)</h3>
        <div class="market" id="market-container"></div>
    </div>

    <div id="panel-over" class="panel" style="display:none; text-align: center;">
        <h1 style="color:var(--gold)">ğŸ† äººç”Ÿæœ€çµ‚çµç®—</h1>
        <div id="final-list"></div>
        <button onclick="location.reload()" class="btn-roll">é‡å•Ÿä¸‹ä¸€ä¸–</button>
    </div>
</div>

<script>
    const resColor = { 'é‡‘éŒ¢': '#f1c40f', 'æ™ºæ…§': '#3498db', 'äººéš›': '#e67e22', 'å¥åº·': '#9b59b6', 'ç¬‘è‡‰': '#2ecc71' };
    
    // è±å¯Œçš„å•†åº—å“é … (å¤šå°å¤š)
    const marketItems = [
        { n: 'æ–œæ§“å‰µæ¥­', cost: { 'æ™ºæ…§':1, 'äººéš›':1 }, gains: { 'é‡‘éŒ¢':2, 'æ™ºæ…§':1 } },
        { n: 'è·¨åœ‹å¿—å·¥', cost: { 'å¥åº·':1, 'é‡‘éŒ¢':1 }, gains: { 'äººéš›':2, 'æ™ºæ…§':1 } },
        { n: 'èº«å¿ƒéˆå·¥ä½œåŠ', cost: { 'é‡‘éŒ¢':2 }, gains: { 'å¥åº·':1, 'æ™ºæ…§':1, 'äººéš›':1 } },
        { n: 'é¦¬æ‹‰æ¾æŒ‘æˆ°', cost: { 'å¥åº·':2 }, gains: { 'å¥åº·':1, 'æ™ºæ…§':1 } },
        { n: 'æ”¿å•†åæµæ™šå®´', cost: { 'é‡‘éŒ¢':1, 'æ™ºæ…§':1 }, gains: { 'äººéš›':3 } },
        { n: 'ç ”ç™¼å°ˆåˆ©', cost: { 'æ™ºæ…§':2, 'é‡‘éŒ¢':1 }, gains: { 'æ™ºæ…§':2, 'é‡‘éŒ¢':2 } },
        { n: 'ç”°åœ’ç”Ÿæ´»', cost: { 'é‡‘éŒ¢':1 }, gains: { 'å¥åº·':1, 'äººéš›':1 } },
        { n: 'é€±æœ«èšæœƒ', cost: { 'äººéš›':1 }, gains: { 'äººéš›':1, 'å¥åº·':1 } }
    ];

    const scoringRules = [
        { desc: "ğŸ’° å¯¦æ¥­å®¶ï¼šé‡‘éŒ¢æ¨™ç±¤ x3åˆ†ï¼Œå…¶é¤˜ x1åˆ†", type: 'é‡‘éŒ¢' },
        { desc: "ğŸ’¡ æ€æƒ³å®¶ï¼šæ™ºæ…§æ¨™ç±¤ x3åˆ†ï¼Œå…¶é¤˜ x1åˆ†", type: 'æ™ºæ…§' },
        { desc: "ğŸ¤ äº¤éš›ç‹ï¼šäººéš›æ¨™ç±¤ x3åˆ†ï¼Œå…¶é¤˜ x1åˆ†", type: 'äººéš›' },
        { desc: "ğŸ¥ å¥åº·å¤§å¸«ï¼šå¥åº·æ¨™ç±¤ x3åˆ†ï¼Œå…¶é¤˜ x1åˆ†", type: 'å¥åº·' }
    ];

    let players = [], curIdx = 0, curRound = 1, turnRes = {};

    function initGame() {
        players = Array.from({length:10}, (_, i) => ({
            id: i+1, job: ["é†«ç”Ÿ","é§­å®¢","ç•«å®¶","åµæ¢","å»šå¸«","æ©Ÿå¸«","è¾²å¤«","è©©äºº","å°éŠ","å¤ªç©ºäºº"][i],
            achievements: [], 
            rule: scoringRules[Math.floor(Math.random() * scoringRules.length)]
        }));
        updateUI();
    }

    function updateUI() {
        const p = players[curIdx];
        document.getElementById('round-num').innerText = curRound;
        document.getElementById('player-label').innerText = curIdx + 1;
        document.getElementById('display-job').innerText = p.job;
        document.getElementById('display-rule').innerText = p.rule.desc;
        document.getElementById('inv-container').innerHTML = p.achievements.map(a => `<span class="inv-tag">${a.n}</span>`).join('');
        renderMarket();
    }

    function renderMarket() {
        document.getElementById('market-container').innerHTML = marketItems.map((c, idx) => {
            let costHtml = Object.entries(c.cost).map(([k,v])=>`<span class="res-mini" style="background:${resColor[k]}">${k}x${v}</span>`).join('');
            let gainHtml = Object.entries(c.gains).map(([k,v])=>`<span class="res-mini" style="background:${resColor[k]}">${k}x${v}</span>`).join('');
            return `
            <div class="card">
                <b style="font-size:14px; color:var(--main);">${c.n}</b>
                <div class="cost-area"><div class="section-title">ä»˜å‡ºä»£åƒ¹</div>${costHtml}</div>
                <div class="gain-area"><div class="section-title">ç²å¾—æ¨™ç±¤</div>${gainHtml}</div>
                <button class="btn-buy" onclick="buyCard(${idx})">ç²å–æˆå°±</button>
            </div>`;
        }).join('');
    }

    function rollDice() {
        turnRes = { 'äººéš›':0, 'é‡‘éŒ¢':0, 'æ™ºæ…§':0, 'å¥åº·':0, 'ç¬‘è‡‰':0 };
        let cries = 0, diceHtml = "";
        for(let i=0; i<4; i++) {
            let r = Object.keys(resColor)[Math.floor(Math.random()*5)];
            if(r === 'ç¬‘è‡‰') turnRes['ç¬‘è‡‰']++;
            else turnRes[r]++;
            diceHtml += `<div class="dice" style="background:${resColor[r]}">${r === 'ç¬‘è‡‰' ? 'ğŸ˜Š' : r}</div>`;
        }
        // éš¨æ©Ÿæ±ºå®šå“­è‡‰ (ç´„ 1/6 æ©Ÿç‡)
        if(Math.random() < 0.25) cries = Math.random() > 0.7 ? 2 : 1;

        document.getElementById('dice-container').innerHTML = diceHtml + (cries > 0 ? `<div class="dice" style="background:${varRed}">ğŸ’€</div>` : "");
        document.getElementById('roll-btn').disabled = true;
        renderTurnRes();
        if (cries > 0) triggerFate(cries);
    }

    const varRed = '#e74c3c';

    function triggerFate(count) {
        const overlay = document.getElementById('event-overlay');
        const desc = document.getElementById('event-desc');
        overlay.style.display = 'flex';
        if (count === 1) {
            const tasks = ["è·Ÿéš”å£ç©å®¶é€²è¡Œä¸€æ¬¡äº¤æ›ç¦®ç‰©(å¯¦é«”æˆ–å£é ­æ‰¿è«¾)", "æ¨¡ä»¿ä¸€ä½åœ¨å ´ç©å®¶çš„æ‹›ç‰Œå‹•ä½œ", "å°å·¦æ‰‹é‚Šçš„ç©å®¶å”±ä¸€å¥æ­Œ", "è¬›ä¸€å€‹å†·ç¬‘è©±"];
            desc.innerText = "ğŸ² 1å€‹å“­è‡‰ (ç‰¹æ®Šä»»å‹™)ï¼š\n" + tasks[Math.floor(Math.random()*tasks.length)];
        } else {
            desc.innerText = "ğŸ’€ 2å€‹å“­è‡‰ (è³‡æºé‡å‰µ)ï¼š\næœ¬å›åˆæ‰€æœ‰å¯ç”¨è³‡æºæ¸›åŠï¼Œä¸”ç¬‘è‡‰å¤±æ•ˆï¼";
            turnRes['ç¬‘è‡‰'] = 0;
            Object.keys(turnRes).forEach(k => turnRes[k] = Math.floor(turnRes[k]/2));
            renderTurnRes();
        }
    }

    function closeEvent() { document.getElementById('event-overlay').style.display = 'none'; checkTurnEnd(); }

    function buyCard(idx) {
        const c = marketItems[idx];
        const p = players[curIdx];
        
        // æª¢æŸ¥è³‡æºæ˜¯å¦è¶³å¤  (åŒ…å«ç¬‘è‡‰è£œä½)
        let tempRes = {...turnRes};
        let canAfford = true;
        
        for (let [res, amt] of Object.entries(c.cost)) {
            let needed = amt;
            let takeNormal = Math.min(tempRes[res], needed);
            needed -= takeNormal;
            if (needed > 0) {
                if (tempRes['ç¬‘è‡‰'] >= needed) {
                    tempRes['ç¬‘è‡‰'] -= needed;
                } else {
                    canAfford = false;
                    break;
                }
            }
        }

        if (canAfford) {
            // åŸ·è¡Œæ‰£æ¬¾
            for (let [res, amt] of Object.entries(c.cost)) {
                let needed = amt;
                let takeNormal = Math.min(turnRes[res], needed);
                turnRes[res] -= takeNormal;
                needed -= takeNormal;
                if (needed > 0) turnRes['ç¬‘è‡‰'] -= needed;
            }
            p.achievements.push({...c});
            renderTurnRes(); updateUI(); checkTurnEnd();
        } else alert("è³‡æº(å«è¬èƒ½ç¬‘è‡‰)ä¸è¶³ï¼");
    }

    function renderTurnRes() {
        let txt = Object.entries(turnRes).filter(([k,v])=>v>0).map(([k,v])=>`${k}x${v}`).join(' / ');
        document.getElementById('res-list').innerText = "å¯ç”¨è³‡æºï¼š" + (txt || "ç„¡");
    }

    function checkTurnEnd() {
        const canBuy = marketItems.some(c => {
            let neededSmile = 0;
            for(let [r, a] of Object.entries(c.cost)) {
                neededSmile += Math.max(0, a - turnRes[r]);
            }
            return turnRes['ç¬‘è‡‰'] >= neededSmile;
        });
        if (!canBuy && document.getElementById('event-overlay').style.display === 'none') {
            setTimeout(() => { alert("æ›ä¸‹ä¸€å€‹äººç¶“ç‡Ÿäººç”Ÿï¼"); nextPlayer(); }, 1000);
        }
    }

    function nextPlayer() {
        curIdx++;
        if(curIdx >= 10) { curIdx = 0; curRound++; if(curRound > 5) return endGame(); }
        document.getElementById('roll-btn').disabled = false;
        document.getElementById('dice-container').innerHTML = "";
        document.getElementById('res-list').innerText = "ç­‰å¾…æ“²éª°...";
        updateUI();
    }

    function endGame() {
        document.getElementById('panel-main').style.display = 'none';
        document.getElementById('panel-over').style.display = 'block';
        
        let results = players.map(p => {
            let totalTags = { 'é‡‘éŒ¢':0, 'æ™ºæ…§':0, 'äººéš›':0, 'å¥åº·':0 };
            p.achievements.forEach(card => {
                for (let [type, val] of Object.entries(card.gains)) {
                    totalTags[type] += val;
                }
            });
            let score = 0;
            for (let [type, count] of Object.entries(totalTags)) {
                score += (type === p.rule.type) ? (count * 3) : (count * 1);
            }
            return { job: p.job, score: score, tags: totalTags, rule: p.rule.desc };
        }).sort((a,b) => b.score - a.score);

        document.getElementById('final-list').innerHTML = results.map((r, i) => `
            <div style="padding:15px; border-bottom:1px solid #eee; text-align:left;">
                <b>${i+1}. ${r.job}</b> <small>(${r.rule})</small>
                <div style="font-size:11px; margin-top:5px; color:#666;">
                    æˆå°±ç¸½è¦½ï¼šğŸ’°${r.tags['é‡‘éŒ¢']} ğŸ’¡${r.tags['æ™ºæ…§']} ğŸ¤${r.tags['äººéš›']} ğŸ¥${r.tags['å¥åº·']}
                </div>
                <div style="color:var(--red); font-weight:bold; font-size:1.5rem;">ç¸½åƒ¹å€¼ï¼š${r.score} åˆ†</div>
            </div>`).join('');
    }
    initGame();
</script>
</body>
</html>
