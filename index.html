<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CV äººç”Ÿå±¥æ­· - ç©åˆ†å¹³è¡¡ç‰ˆ</title>
    <style>
        :root { --main: #2c3e50; --accent: #e67e22; --bg: #f5f7fa; --green: #27ae60; --red: #e74c3c; --gold: #d4af37; --blue: #3498db; }
        body { font-family: 'PingFang TC', sans-serif; background: var(--bg); margin: 0; padding: 10px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 500px; }
        .header-info { display: flex; justify-content: space-between; background: var(--main); color: white; padding: 10px 15px; border-radius: 8px; margin-bottom: 10px; font-weight: bold; font-size: 14px; }
        .tab-nav { display: flex; gap: 8px; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 12px; border: none; border-radius: 8px; background: #ddd; cursor: pointer; font-weight: bold; }
        .tab-btn.active { background: #34495e; color: white; }
        .panel { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: none; }
        .panel.active { display: block; }
        .secret-area { background: #f8f9fa; padding: 10px; border-radius: 10px; margin: 10px 0; border: 2px dashed #cbd5e0; text-align: center; }
        .secret-text { display: none; color: var(--red); font-weight: bold; font-size: 1.2rem; }
        .dice-display { display: flex; justify-content: center; gap: 5px; margin: 10px 0; min-height: 65px; flex-wrap: wrap; }
        .dice { width: 50px; height: 50px; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.7rem; box-shadow: 0 3px 0 rgba(0,0,0,0.2); }
        .market { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .card { border: 2px solid #eee; padding: 10px; border-radius: 10px; text-align: center; position: relative; min-height: 100px; display: flex; flex-direction: column; justify-content: space-between; }
        .card.lv3 { border-color: var(--gold); background: #fffdf0; border-width: 3px; }
        .card.lv2 { border-color: var(--blue); }
        .score-badge { position: absolute; top: -8px; right: -8px; background: var(--red); color: white; border-radius: 50%; width: 24px; height: 24px; font-size: 12px; line-height: 24px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .btn-buy { background: var(--green); color: white; border: none; width: 100%; padding: 10px; border-radius: 6px; margin-top: 8px; cursor: pointer; font-weight: bold; }
        .others-item { border-bottom: 1px solid #eee; padding: 12px 0; display: flex; justify-content: space-between; align-items: center; }
        .rank-num { background: var(--main); color: white; width: 25px; height: 25px; border-radius: 50%; display: inline-block; text-align: center; line-height: 25px; margin-right: 10px; }
        .winner { background: #fff9c4; border: 2px solid var(--gold); padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-info">
        <span>ğŸ“… ç¬¬ <span id="round-num">1</span> / 5 å›åˆ</span>
        <span>ğŸ‘¤ ç©å®¶ï¼š<span id="player-label">1</span> / 10</span>
    </div>

    <div class="tab-nav" id="main-nav">
        <button class="tab-btn active" onclick="switchTab('play')">ğŸ® è¡Œå‹•</button>
        <button class="tab-btn" onclick="switchTab('view')">ğŸ‘ï¸ æ’å</button>
        <button class="tab-btn" onclick="switchTab('admin')" style="background:#718096; color:white;">âš™ï¸ GM</button>
    </div>

    <div id="panel-play" class="panel active">
        <div style="text-align: center;">
            <h2 id="display-job" style="margin: 5px 0; color: var(--main);">--</h2>
            <div class="secret-area">
                <button onmousedown="showSecret(true)" onmouseup="showSecret(false)" ontouchstart="showSecret(true)" ontouchend="showSecret(false)" style="cursor:pointer; padding:5px 10px;">ğŸ” æŒ‰ä½æŸ¥çœ‹éš±è—æ™‚æœŸ</button>
                <div id="secret-info" class="secret-text">---</div>
            </div>
            <div style="font-size: 13px;">æˆ‘çš„å¸¸é§å¤©è³¦ï¼š<b id="display-talent" style="color:var(--accent)">--</b></div>
        </div>

        <button id="roll-btn" class="btn-roll" onclick="rollDice()" style="background:var(--accent); color:white; border:none; padding:12px; width:100%; border-radius:8px; margin-top:10px; font-weight:bold; cursor:pointer; font-size:16px;">ğŸ² æ“²éª°å­ (4é¡†)</button>
        <div class="dice-display" id="dice-container"></div>
        <div id="res-list" style="text-align:center; font-size:15px; font-weight:bold; color:var(--main); margin:5px 0;">ç­‰å¾…æ“²éª°...</div>
        <div id="miracle-hint" style="text-align:center; color:var(--gold); font-size:13px; font-weight:bold;"></div>

        <h3 style="font-size: 15px; border-left: 4px solid var(--main); padding-left: 8px; margin-top: 15px;">å¡ç‰Œå•†åº—</h3>
        <div class="market" id="market-container"></div>
    </div>

    <div id="panel-view" class="panel">
        <h3>ğŸ† ç•¶å‰ç©åˆ†æ’å</h3>
        <div id="others-container"></div>
    </div>

    <div id="panel-over" class="panel" style="text-align: center;">
        <h1 style="color:var(--gold)">ğŸŠ éŠæˆ²å¤§çµå±€ ğŸŠ</h1>
        <div id="final-rank-list"></div>
        <button onclick="location.reload()" style="background:var(--main); color:white; padding:12px 25px; border:none; border-radius:8px; margin-top:20px; font-weight:bold;">é–‹å•Ÿæ–°çš„äººç”Ÿ</button>
    </div>

    <div id="panel-admin" class="panel">
        <button onclick="initGame()" style="background:var(--red); color:white; padding:15px; width:100%; border:none; border-radius:8px; font-weight:bold;">ğŸ”„ é‡æ–°åˆå§‹åŒ– (æ´—ç‰Œ)</button>
    </div>
</div>

<script>
    const diceFaces = [
        { n: 'äººéš›', c: '#e67e22', i: 'ğŸ¤' }, { n: 'é‡‘éŒ¢', c: '#f1c40f', i: 'ğŸ’°' },
        { n: 'æ™ºæ…§', c: '#3498db', i: 'ğŸ’¡' }, { n: 'ç¬‘è‡‰', c: '#2ecc71', i: 'ğŸ˜Š' },
        { n: 'å“­è‡‰', c: '#e74c3c', i: 'ğŸ’€' }, { n: 'å¥åº·', c: '#9b59b6', i: 'ğŸ¥' }
    ];

    const allPeriods = ["å¹¼å¹´æœŸ", "å…¥å­¸æœŸ", "é’æ˜¥æœŸ", "åŒ—æ¼‚æœŸ", "æˆå®¶æœŸ", "å£¯å¹´æœŸ", "å±æ©ŸæœŸ", "å›ç”˜æœŸ", "éš±å±…æœŸ", "å‚³å¥‡æœŸ"];
    const p1 = ["å¹¼å¹´æœŸ", "å…¥å­¸æœŸ", "é’æ˜¥æœŸ"];
    const p2 = ["åŒ—æ¼‚æœŸ", "æˆå®¶æœŸ", "å£¯å¹´æœŸ", "å±æ©ŸæœŸ"];
    const p3 = ["å›ç”˜æœŸ", "éš±å±…æœŸ", "å‚³å¥‡æœŸ"];
    const publicJobs = ["åµæ¢", "å»šå¸«", "å¤ªç©ºäºº", "ç•«å®¶", "é†«ç”Ÿ", "é§­å®¢", "è¾²å¤«", "è©©äºº", "å°éŠ", "æ©Ÿå¸«"];
    const talents = ['é‡‘éŒ¢', 'æ™ºæ…§', 'äººéš›', 'ç¬‘è‡‰'];

    let players = [];
    let currentIdx = 0;
    let currentRound = 1;
    let currentRes = {};
    let hasMiracle = false;

    // å®šç¾©å¡æ± ï¼š1åˆ†ç‰Œå¤šï¼Œ2åˆ†å°‘ï¼Œ3åˆ†ç¨€æœ‰ä¸”è¼ƒé›£
    const cardDatabase = {
        lvl1: [
            {n:'æ…¢è·‘', t:'å¥åº·', q:1}, {n:'ç¤¾äº¤', t:'äººéš›', q:1}, {n:'çœ‹æ›¸', t:'æ™ºæ…§', q:1},
            {n:'å­˜éŒ¢', t:'é‡‘éŒ¢', q:1}, {n:'å¤§ç¬‘', t:'ç¬‘è‡‰', q:1}, {n:'å…¼è·', t:'é‡‘éŒ¢', q:2},
            {n:'å†¥æƒ³', t:'å¥åº·', q:1}, {n:'èšé¤', t:'äººéš›', q:2}
        ],
        lvl2: [
            {n:'å°ˆæ¥­è­‰ç…§', t:'æ™ºæ…§', q:2, tg: allPeriods.slice(2, 8)},
            {n:'é¦¬æ‹‰æ¾', t:'å¥åº·', q:2, tg: allPeriods.slice(0, 5)},
            {n:'ç’°éŠä¸–ç•Œ', t:'ç¬‘è‡‰', q:2, tg: allPeriods.slice(5, 10)},
            {n:'ç¤¾äº¤é”äºº', t:'äººéš›', q:2, tg: allPeriods.slice(2, 7)}
        ],
        lvl3_early: [{n:'è³‡å„ªç”Ÿ', t:'æ™ºæ…§', q:3, tg: p1}, {n:'æ ¡éšŠéšŠé•·', t:'å¥åº·', q:3, tg: p1}],
        lvl3_mid: [{n:'è³¼ç½®æˆ¿ç”¢', t:'é‡‘éŒ¢', q:3, tg: p2}, {n:'å…¬å¸åˆå¤¥', t:'æ™ºæ…§', q:3, tg: p2}],
        lvl3_late: [{n:'æ’°å¯«å‚³è¨˜', t:'æ™ºæ…§', q:3, tg: p3}, {n:'é¤Šç”Ÿé•·å£½', t:'å¥åº·', q:3, tg: p3}]
    };

    function getMarket() {
        // æ¯”ä¾‹ï¼š4å¼µ1åˆ†ï¼Œ2å¼µ2åˆ†ï¼Œ1å¼µ3åˆ†
        let market = [];
        market.push(...cardDatabase.lvl1.sort(()=>.5-Math.random()).slice(0,4).map(c=>({...c, lv:1, tg:[]})));
        market.push(...cardDatabase.lvl2.sort(()=>.5-Math.random()).slice(0,2).map(c=>({...c, lv:2})));
        
        let l3 = (currentRound <= 2) ? cardDatabase.lvl3_early : (currentRound <= 4 ? cardDatabase.lvl3_mid : cardDatabase.lvl3_late);
        market.push({...l3[Math.floor(Math.random()*l3.length)], lv:3});
        
        return market.sort(()=>.5-Math.random());
    }

    let currentMarket = [];

    function initGame() {
        let shuffled = [...allPeriods].sort(() => Math.random() - 0.5);
        players = Array.from({length:10}, (_, i) => ({
            id: i+1, job: publicJobs[i], secret: shuffled[i], 
            talent: talents[Math.floor(Math.random()*4)], inventory: [], score: 0
        }));
        currentRound = 1; currentIdx = 0; currentMarket = getMarket();
        updateUI(); resetTurn(); switchTab('play');
    }

    function switchTab(tabId) {
        document.querySelectorAll('.panel').forEach(p => p.style.display = 'none');
        document.getElementById('panel-' + tabId).style.display = 'block';
        if(tabId === 'view') updateViewTab();
    }

    function updateUI() {
        const p = players[currentIdx];
        document.getElementById('round-num').innerText = currentRound;
        document.getElementById('player-label').innerText = currentIdx + 1;
        document.getElementById('display-job').innerText = p.job;
        document.getElementById('display-talent').innerText = p.talent;
        renderMarket();
    }

    function renderMarket() {
        document.getElementById('market-container').innerHTML = currentMarket.map(c => `
            <div class="card lv${c.lv}">
                <div class="score-badge">+${c.lv}</div>
                <b style="font-size:15px;">${c.n}</b>
                <small style="color:#666;">éœ€æ±‚: ${c.q}å€‹${c.t}</small>
                <button class="btn-buy" onclick="buyCard('${c.n}', '${c.t}', ${c.q}, ${c.lv}, '${(c.tg||[]).join(',')}')">è³¼è²·</button>
            </div>
        `).join('');
    }

    function showSecret(show) {
        const info = document.getElementById('secret-info');
        info.style.display = show ? 'block' : 'none';
        info.innerText = players[currentIdx].secret;
    }

    function rollDice() {
        const p = players[currentIdx];
        let cries = 0; let smiles = 0;
        currentRes = { 'äººéš›':0, 'é‡‘éŒ¢':0, 'æ™ºæ…§':0, 'ç¬‘è‡‰':0, 'å¥åº·':0 };
        currentRes[p.talent] = 1; // å¤©è³¦ä¿åº•
        if(p.talent === 'ç¬‘è‡‰') smiles = 1;

        let html = "";
        for(let i=0; i<4; i++) {
            let r = diceFaces[Math.floor(Math.random()*6)];
            if(r.n==='å“­è‡‰') cries++;
            else { currentRes[r.n]++; if(r.n==='ç¬‘è‡‰') smiles++; }
            html += `<div class="dice" style="background:${r.c}">${r.i}<br>${r.n}</div>`;
        }
        document.getElementById('dice-container').innerHTML = html;
        if(cries >= 3) { alert("ğŸ’€ å“­è‡‰éå¤šï¼è³‡æºå¤±æ•ˆã€‚"); nextPlayer(); }
        else {
            hasMiracle = (smiles >= 3);
            document.getElementById('miracle-hint').innerText = hasMiracle ? "ğŸŒŸ é”æˆå¥‡è¹Ÿï¼æœ¬å›åˆå¯ä»»é¸ä¸€å¡ã€‚" : "";
            document.getElementById('roll-btn').disabled = true;
            renderResSummary(); checkCanAffordAnything();
        }
    }

    function renderResSummary() {
        let txt = Object.entries(currentRes).filter(([k,v])=>v>0).map(([k,v])=>`${k}x${v}`).join(' / ');
        document.getElementById('res-list').innerText = "å¯ç”¨è³‡æº: " + (txt || "ç„¡");
    }

    function buyCard(n, t, q, lv, tgStr) {
        const p = players[currentIdx];
        const tg = tgStr ? tgStr.split(',') : [];
        let canBuy = hasMiracle;
        if (!canBuy && currentRes[t] >= q) { currentRes[t] -= q; canBuy = true; }
        
        if (canBuy) {
            let gain = 1;
            if (lv === 3 && tg.includes(p.secret)) gain = 3;
            else if (lv === 2 && tg.includes(p.secret)) gain = 2;
            
            p.score += gain; p.inventory.push(n);
            hasMiracle = false; document.getElementById('miracle-hint').innerText = "";
            alert(`âœ… è³¼è²·ã€Œ${n}ã€æˆåŠŸï¼ç©åˆ† +${gain}`);
            renderResSummary(); checkCanAffordAnything();
        } else alert("âŒ è³‡æºä¸å¤ å–”ï¼");
    }

    function checkCanAffordAnything() {
        if(hasMiracle) return;
        if (!currentMarket.some(c => currentRes[c.t] >= c.q)) {
            setTimeout(() => { alert("ğŸ“¢ æ²’éŒ¢è²·äº†ï¼Œæ›ä¸‹ä¸€ä½ï¼"); nextPlayer(); }, 600);
        }
    }

    function nextPlayer() {
        currentIdx++;
        if (currentIdx >= 10) {
            currentIdx = 0; currentRound++;
            if (currentRound > 5) return endGame();
            currentMarket = getMarket(); // æ¯ä¸€è¼ªé‡æ–°æ›´æ–°å¸‚å ´
            alert(`ğŸ“¢ ç¬¬ ${currentRound} å›åˆé–‹å§‹ï¼å¸‚å ´å·²ç¿»æ–°ã€‚`);
        }
        resetTurn(); updateUI();
    }

    function resetTurn() {
        currentRes = {}; hasMiracle = false;
        document.getElementById('dice-container').innerHTML = "";
        document.getElementById('res-list').innerText = "ç­‰å¾…æ“²éª°...";
        document.getElementById('miracle-hint').innerText = "";
        document.getElementById('roll-btn').disabled = false;
    }

    function updateViewTab() {
        const sorted = [...players].sort((a,b) => b.score - a.score);
        document.getElementById('others-container').innerHTML = sorted.map((p, i) => `
            <div class="others-item">
                <span><span class="rank-num">${i+1}</span> <b>${p.job}</b></span>
                <span style="color:var(--red); font-weight:bold;">${p.score} åˆ†</span>
            </div>
        `).join('');
    }

    function endGame() {
        document.getElementById('main-nav').style.display = 'none';
        document.querySelectorAll('.panel').forEach(p => p.style.display = 'none');
        document.getElementById('panel-over').style.display = 'block';
        
        const sorted = [...players].sort((a,b) => b.score - a.score);
        document.getElementById('final-rank-list').innerHTML = `
            <div class="winner">
                <h2 style="margin:0;">ğŸ¥‡ ç¬¬ä¸€åï¼š${sorted[0].job}</h2>
                <h3 style="color:var(--red); margin:5px 0;">æœ€çµ‚ç©åˆ†ï¼š${sorted[0].score} åˆ†</h3>
            </div>
        ` + sorted.slice(1).map((p, i) => `
            <div style="margin:8px 0; border-bottom:1px solid #eee; padding-bottom:5px;">
                ç¬¬ ${i+2} åï¼š${p.job} (${p.score} åˆ†)
            </div>
        `).join('');
    }

    initGame();
</script>
</body>
</html>
