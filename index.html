<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CV äººç”Ÿå±¥æ­· - å‹•æ…‹å¸‚å ´ç‰ˆ</title>
    <style>
        :root { --main: #2c3e50; --accent: #e67e22; --bg: #f5f7fa; --green: #27ae60; --red: #e74c3c; --blue: #3498db; --gold: #f1c40f; }
        body { font-family: 'PingFang TC', sans-serif; background: var(--bg); margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 500px; position: relative; }
        #alert-msg { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--main); color: white; padding: 10px 20px; border-radius: 20px; font-weight: bold; z-index: 1000; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .header-info { display: flex; justify-content: space-between; background: var(--main); color: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; font-weight: bold; }
        .panel { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .tabs { display: flex; gap: 5px; margin-bottom: 10px; }
        .tab-btn { flex: 1; padding: 8px; border: none; background: #ddd; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .tab-btn.active { background: var(--blue); color: white; }
        .rule-box { background: #fffde7; border: 1px solid var(--gold); padding: 8px; border-radius: 8px; font-size: 13px; color: #555; font-weight: bold; text-align: center; }
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 10px 0; }
        .btn { padding: 15px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; color: white; font-size: 16px; }
        .btn-roll { background: var(--accent); }
        .btn-end { background: var(--main); }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .dice-display { display: flex; justify-content: center; gap: 6px; margin: 10px 0; height: 50px; }
        .dice { width: 45px; height: 45px; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.7rem; }
        .res-summary { text-align:center; font-weight:bold; margin-bottom: 15px; color: var(--main); background: #edf2f7; padding: 10px; border-radius: 5px; }
        .market { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .card { border: 1px solid #eee; padding: 10px; border-radius: 10px; display: flex; flex-direction: column; justify-content: space-between; min-height: 150px; background: #fafafa; position: relative; }
        .cost-area { background: #ffebeb; color: #c00; font-size: 11px; padding: 3px; border-radius: 4px; margin: 2px 0; }
        .gain-area { background: #ebffeb; color: #060; font-size: 11px; padding: 3px; border-radius: 4px; margin: 2px 0; }
        .res-tag { display: inline-block; padding: 1px 3px; border-radius: 3px; margin: 1px; color: white; font-size: 9px; }
        .btn-buy { background: var(--green); color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer; font-weight: bold; margin-top: 5px; }
        .special-badge { position: absolute; top: -5px; right: -5px; background: var(--gold); color: black; font-size: 8px; padding: 2px 4px; border-radius: 10px; font-weight: bold; border: 1px solid black; }
    </style>
</head>
<body>

<div id="alert-msg"></div>

<div class="container">
    <div class="header-info">
        <span>ğŸ“… ç¬¬ <span id="round-num">1</span> / 5 è¼ª</span>
        <span>ğŸ‘¤ ç©å®¶ <span id="player-label">1</span> / 10</span>
    </div>

    <div class="tabs">
        <button id="tab-game" class="tab-btn active" onclick="switchTab('game')">ç•¶å‰è¡Œå‹•</button>
        <button id="tab-others" class="tab-btn" onclick="switchTab('others')">æŸ¥çœ‹å°æ‰‹</button>
    </div>

    <div id="panel-game" class="panel">
        <div id="display-job" style="text-align:center; font-weight:bold; font-size:1.2rem; color:var(--main);">--</div>
        <div id="display-rule" class="rule-box" style="margin: 10px 0;">--</div>
        <div style="font-size:12px; text-align:center;">ç´¯ç©è³‡ç”¢ï¼š<span id="my-tags" style="color:var(--blue); font-weight:bold;">ç„¡</span></div>

        <div class="controls">
            <button id="roll-btn" class="btn btn-roll" onclick="rollDice()">ğŸ² æ“²éª°å­</button>
            <button id="end-btn" class="btn btn-end" onclick="nextPlayer()" disabled>ğŸ çµæŸå›åˆ</button>
        </div>

        <div class="dice-display" id="dice-container"></div>
        <div id="res-list" class="res-summary">ç­‰å¾…æ“²éª°ç²å–è³‡æº...</div>

        <div class="market" id="market-container"></div>
    </div>

    <div id="panel-others" class="panel" style="display:none;">
        <h3>å„ç©å®¶ç´¯ç©è³‡ç”¢</h3>
        <div id="other-players-list-content"></div>
    </div>

    <div id="panel-over" class="panel" style="display:none; text-align: center;">
        <h1 style="color:var(--gold)">ğŸ† æˆå°±çµç®—</h1>
        <div id="final-list"></div>
        <button onclick="location.reload()" class="btn btn-roll" style="width:100%; margin-top:20px;">é‡æ–°é–‹å§‹</button>
    </div>
</div>

<script>
    const resColor = { 'é‡‘éŒ¢': '#f1c40f', 'æ™ºæ…§': '#3498db', 'äººéš›': '#e67e22', 'å¥åº·': '#9b59b6', 'ç¬‘è‡‰': '#2ecc71' };
    
    // æ“´å……å¡æ± ï¼šç¸½å…± 20 ç¨®å¡ç‰‡ï¼Œæ¯è¼ªéš¨æ©ŸæŠ½ 6 å¼µ
    const fullCardPool = [
        { n: 'çŸ½è°·å‰µæ¥­', cost: { 'æ™ºæ…§':2, 'äººéš›':1 }, gains: { 'é‡‘éŒ¢':4 } },
        { n: 'ç’°çƒæ—…è¡Œ', cost: { 'é‡‘éŒ¢':2 }, gains: { 'äººéš›':2, 'å¥åº·':1 } },
        { n: 'é†«å­¸é™¢', cost: { 'æ™ºæ…§':3 }, gains: { 'æ™ºæ…§':2, 'å¥åº·':2 } },
        { n: 'å¥§é‹è¨“ç·´', cost: { 'å¥åº·':3 }, gains: { 'å¥åº·':2, 'äººéš›':1 } },
        { n: 'æ•¸ä½è¡ŒéŠ·', cost: { 'äººéš›':2 }, gains: { 'é‡‘éŒ¢':2, 'æ™ºæ…§':1 } },
        { n: 'ç‘œçˆå†¥æƒ³', cost: { 'æ™ºæ…§':1, 'å¥åº·':1 }, gains: { 'å¥åº·':2, 'æ™ºæ…§':1 } },
        { n: 'è‚¡å¸‚é«˜æ‰‹', cost: { 'é‡‘éŒ¢':1, 'æ™ºæ…§':1 }, gains: { 'é‡‘éŒ¢':3 } },
        { n: 'æ¨‚åœ˜ä¸»å”±', cost: { 'äººéš›':1, 'å¥åº·':1 }, gains: { 'äººéš›':3 } },
        { n: 'é¦¬æ‹‰æ¾', cost: { 'å¥åº·':2 }, gains: { 'å¥åº·':3 } },
        { n: 'ç¨‹å¼ç«¶è³½', cost: { 'æ™ºæ…§':2 }, gains: { 'æ™ºæ…§':3 } },
        { n: 'ç±³å…¶æ—ä¸»å»š', cost: { 'é‡‘éŒ¢':1, 'æ™ºæ…§':2 }, gains: { 'æ™ºæ…§':1, 'å¥åº·':1, 'äººéš›':1 } },
        { n: 'å¤–äº¤å®˜', cost: { 'æ™ºæ…§':1, 'äººéš›':2 }, gains: { 'äººéš›':3, 'æ™ºæ…§':1 } },
        { n: 'å»ºç¯‰è¨­è¨ˆ', cost: { 'é‡‘éŒ¢':1, 'æ™ºæ…§':2 }, gains: { 'æ™ºæ…§':3 } },
        { n: 'è‡ªçµ¦è‡ªè¶³', cost: { 'å¥åº·':2 }, gains: { 'å¥åº·':1, 'æ™ºæ…§':1, 'é‡‘éŒ¢':1 } },
        { n: 'å¿—å·¥ç¤¾åœ˜', cost: { 'äººéš›':1 }, gains: { 'äººéš›':1, 'æ™ºæ…§':1, 'å¥åº·':1 } },
        { n: 'æˆ¿åœ°ç”¢', cost: { 'é‡‘éŒ¢':3 }, gains: { 'é‡‘éŒ¢':2, 'äººéš›':2 } },
        { n: 'æ¥µé™é‹å‹•', cost: { 'å¥åº·':3 }, gains: { 'å¥åº·':1, 'æ™ºæ…§':2, 'äººéš›':2 } },
        { n: 'ç§‘æ™®ç¶²ç´…', cost: { 'æ™ºæ…§':2, 'äººéš›':1 }, gains: { 'æ™ºæ…§':1, 'äººéš›':3 } },
        { n: 'æ·±å¤œé£Ÿå ‚', cost: { 'é‡‘éŒ¢':1, 'äººéš›':1 }, gains: { 'äººéš›':2, 'å¥åº·':1 } },
        { n: 'ç²¾å“æ”¶è—', cost: { 'é‡‘éŒ¢':3 }, gains: { 'æ™ºæ…§':1, 'äººéš›':2 } }
    ];

    const scoringRules = [
        { desc: "ğŸ’¡æ™ºæ…§ + ğŸ’°é‡‘éŒ¢ é…å° = 3åˆ†", pair: ['æ™ºæ…§', 'é‡‘éŒ¢'] },
        { desc: "ğŸ¤äººéš› + ğŸ’°é‡‘éŒ¢ é…å° = 3åˆ†", pair: ['äººéš›', 'é‡‘éŒ¢'] },
        { desc: "ğŸ¥å¥åº· + ğŸ¤äººéš› é…å° = 3åˆ†", pair: ['å¥åº·', 'äººéš›'] },
        { desc: "ğŸ’¡æ™ºæ…§ + ğŸ¥å¥åº· é…å° = 3åˆ†", pair: ['æ™ºæ…§', 'å¥åº·'] }
    ];

    let players = [], curIdx = 0, curRound = 1, turnRes = {}, hasRolled = false;
    let currentMarket = []; // å­˜å„²ç•¶å‰è¼ªæ¬¡çš„å¡ç‰‡

    function initGame() {
        players = Array.from({length:10}, (_, i) => ({
            id: i+1, job: ["é†«ç”Ÿ","å·¥ç¨‹å¸«","ç•«å®¶","åµæ¢","å»šå¸«","æ©Ÿå¸«","è¾²å¤«","è©©äºº","å°éŠ","å¤ªç©ºäºº"][i],
            allTags: { 'é‡‘éŒ¢':0, 'æ™ºæ…§':0, 'äººéš›':0, 'å¥åº·':0 },
            rule: scoringRules[Math.floor(Math.random() * scoringRules.length)]
        }));
        refreshMarket(); // ç¬¬ä¸€è¼ªé–‹å§‹åˆ·æ–°å¸‚å ´
        updateUI();
    }

    // æ ¸å¿ƒåŠŸèƒ½ï¼šåˆ·æ–°å¸‚å ´å“é …
    function refreshMarket() {
        const shuffled = [...fullCardPool].sort(() => 0.5 - Math.random());
        currentMarket = shuffled.slice(0, 6);
    }

    function switchTab(tab) {
        document.getElementById('panel-game').style.display = tab === 'game' ? 'block' : 'none';
        document.getElementById('panel-others').style.display = tab === 'others' ? 'block' : 'none';
        document.getElementById('tab-game').classList.toggle('active', tab === 'game');
        document.getElementById('tab-others').classList.toggle('active', tab === 'others');
        if(tab === 'others') renderOthers();
    }

    function renderOthers() {
        let content = players.map(p => {
            let tagStr = Object.entries(p.allTags).filter(([k,v])=>v>0).map(([k,v])=>`${k}x${v}`).join(', ');
            return `<div style="padding:10px; border-bottom:1px solid #eee;"><b>ç©å®¶ ${p.id} (${p.job})</b><br><span style="color:var(--blue); font-size:12px;">${tagStr || 'å°šæœªç²å¾—æ¨™ç±¤'}</span></div>`;
        }).join('');
        document.getElementById('other-players-list-content').innerHTML = content;
    }

    function updateUI() {
        const p = players[curIdx];
        document.getElementById('player-label').innerText = p.id;
        document.getElementById('round-num').innerText = curRound;
        document.getElementById('display-job').innerText = p.job;
        document.getElementById('display-rule').innerText = "è¨ˆåˆ†ï¼š" + p.rule.desc;
        let tagTxt = Object.entries(p.allTags).filter(([k,v])=>v>0).map(([k,v])=>`${k}x${v}`).join(' / ');
        document.getElementById('my-tags').innerText = tagTxt || "å°šæœªç´¯ç©è³‡ç”¢";
        renderMarket();
    }

    function renderMarket() {
        document.getElementById('market-container').innerHTML = currentMarket.map((c, idx) => {
            let costH = Object.entries(c.cost).map(([k,v])=>`<span class="res-tag" style="background:${resColor[k]}">${k}x${v}</span>`).join('');
            let gainH = Object.entries(c.gains).map(([k,v])=>`<span class="res-tag" style="background:${resColor[k]}">${k}x${v}</span>`).join('');
            return `<div class="card"><div class="special-badge">3ğŸ˜Š=å¼·æ›</div><b style="font-size:13px;">${c.n}</b>
                <div class="cost-area">ä»˜ï¼š${costH}</div><div class="gain-area">å¾—ï¼š${gainH}</div>
                <button class="btn-buy" onclick="buyCard(${idx})" ${!hasRolled?'disabled':''}>å…Œæ›</button></div>`;
        }).join('');
    }

    function rollDice() {
        turnRes = { 'é‡‘éŒ¢':0, 'æ™ºæ…§':0, 'äººéš›':0, 'å¥åº·':0, 'ç¬‘è‡‰':0 };
        let diceHtml = "";
        for(let i=0; i<6; i++) {
            let r = Object.keys(resColor)[Math.floor(Math.random()*5)];
            turnRes[r]++;
            diceHtml += `<div class="dice" style="background:${resColor[r]}">${r === 'ç¬‘è‡‰' ? 'ğŸ˜Š' : r}</div>`;
        }
        document.getElementById('dice-container').innerHTML = diceHtml;
        hasRolled = true;
        document.getElementById('roll-btn').disabled = true;
        document.getElementById('end-btn').disabled = false;
        renderTurnRes(); renderMarket();
    }

    function buyCard(idx) {
        const c = currentMarket[idx], p = players[curIdx];
        let canAffordNormal = true;
        let tempSmile = turnRes['ç¬‘è‡‰'];

        for (let [res, amt] of Object.entries(c.cost)) {
            let gap = amt - turnRes[res];
            if (gap > 0) {
                if (tempSmile >= gap) tempSmile -= gap;
                else { canAffordNormal = false; break; }
            }
        }

        if (canAffordNormal) {
            for (let [res, amt] of Object.entries(c.cost)) {
                let gap = amt - turnRes[res];
                if (gap > 0) { turnRes['ç¬‘è‡‰'] -= gap; turnRes[res] = 0; }
                else { turnRes[res] -= amt; }
            }
            applyGains(c, p);
        } 
        else if (turnRes['ç¬‘è‡‰'] >= 3) {
            if (confirm("è³‡æºä¸è¶³ï¼Œæ˜¯å¦è¦æ¶ˆè€— 3 å€‹ç¬‘è‡‰å¼·è¡Œå…Œæ›ï¼Ÿ")) {
                turnRes['ç¬‘è‡‰'] -= 3;
                showNotify("âœ¨ ä½¿ç”¨ç¬‘è‡‰ç¥åŠ›ï¼", "var(--gold)", "black");
                applyGains(c, p);
            }
        } else {
            showNotify("âŒ è³‡æºä¸è¶³ï¼", "var(--red)", "white");
        }
    }

    function applyGains(c, p) {
        for (let [res, amt] of Object.entries(c.gains)) { p.allTags[res] += amt; }
        renderTurnRes(); updateUI();
    }

    function showNotify(msg, bg, color) {
        const el = document.getElementById('alert-msg');
        el.innerText = msg; el.style.background = bg; el.style.color = color; el.style.display = 'block';
        setTimeout(() => el.style.display = 'none', 2000);
    }

    function renderTurnRes() {
        let txt = Object.entries(turnRes).filter(([k,v])=>v>0).map(([k,v])=>`${k}x${v}`).join(' / ');
        document.getElementById('res-list').innerText = "å¯ç”¨è³‡æºï¼š" + (txt || "å·²ç”¨ç›¡");
    }

    function nextPlayer() {
        curIdx++;
        // ç•¶ç¬¬ 10 ä½ç©å®¶çµæŸï¼Œè¼ªåˆ°ä¸‹ä¸€è¼ªæ™‚ï¼Œåˆ·æ–°å¸‚å ´
        if(curIdx >= 10) { 
            curIdx = 0; 
            curRound++; 
            if(curRound > 5) return endGame(); 
            refreshMarket(); // æ¯ä¸€è¼ªé–‹å§‹ï¼Œæ›ä¸€æ‰¹æˆå°±å¡
            showNotify(`ğŸ“… ç¬¬ ${curRound} è¼ªï¼šå¸‚å ´å·²æ›´æ–°ï¼`, "var(--blue)", "white");
        }
        hasRolled = false; document.getElementById('roll-btn').disabled = false;
        document.getElementById('end-btn').disabled = true;
        document.getElementById('dice-container').innerHTML = "";
        document.getElementById('res-list').innerText = "ç­‰å¾…æ“²éª°...";
        switchTab('game'); updateUI();
    }

    function endGame() {
        document.getElementById('panel-game').style.display = 'none';
        document.getElementById('panel-others').style.display = 'none';
        document.querySelector('.tabs').style.display = 'none';
        document.getElementById('panel-over').style.display = 'block';
        let results = players.map(p => {
            let t = {...p.allTags}, [r1, r2] = p.rule.pair;
            let pairs = Math.min(t[r1], t[r2]);
            let totalScore = (pairs * 3) + (Object.values(t).reduce((a,b)=>a+b, 0) - (pairs * 2));
            return { job: p.job, score: totalScore, tags: p.allTags, rule: p.rule.desc };
        }).sort((a,b) => b.score - a.score);

        document.getElementById('final-list').innerHTML = results.map((r, i) => `
            <div style="padding:12px; border-bottom:1px solid #eee; text-align:left;">
                <b>${i+1}. ${r.job}</b> <br>
                <small>ğŸ’°${r.tags['é‡‘éŒ¢']} ğŸ’¡${r.tags['æ™ºæ…§']} ğŸ¤${r.tags['äººéš›']} ğŸ¥${r.tags['å¥åº·']}</small>
                <div style="color:var(--red); font-weight:bold; font-size:1.2rem;">ç¸½åˆ†ï¼š${r.score}</div>
            </div>`).join('');
    }
    initGame();
</script>
</body>
</html>
