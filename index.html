<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CV éŠæˆ² - ç©å®¶ç«¯</title>
    <style>
        :root { --main: #2c3e50; --accent: #e67e22; --bg: #f5f7fa; --green: #27ae60; --red: #e74c3c; --blue: #3498db; --gold: #f1c40f; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 500px; }
        .panel { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 10px; }
        #setup-screen { position: fixed; inset: 0; background: white; z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .input-box { width: 100%; max-width: 300px; padding: 12px; margin-bottom: 15px; border: 2px solid #ddd; border-radius: 8px; text-align: center; }
        .player-select { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; width: 100%; }
        .header-info { display: flex; justify-content: space-between; background: var(--main); color: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; width: 100%; box-sizing: border-box;}
        .dice-display { display: flex; justify-content: center; gap: 6px; margin: 10px 0; min-height: 50px; }
        .dice { width: 45px; height: 45px; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.8rem; }
        .market { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .card { border: 1px solid #eee; padding: 12px; border-radius: 10px; background: #fafafa; display: flex; flex-direction: column; justify-content: space-between; min-height: 130px; }
        .card.sold-out { opacity: 0.3; }
        .btn { padding: 12px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; color: white; width: 100%; }
        .btn-roll { background: var(--accent); margin-bottom: 5px; }
        .btn-end { background: var(--main); }
        .btn-buy { background: var(--green); margin-top: 5px; font-size: 12px; }
        .btn:disabled { background: #ccc !important; }
        .talent-tag { background: var(--gold); color: #000; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }
    </style>
</head>
<body>
    <div id="setup-screen">
        <h2 style="color:var(--main)">ğŸ§¬ CV äººç”Ÿå±¥æ­·</h2>
        <input type="text" id="user-name" class="input-box" placeholder="è¼¸å…¥ä½ çš„æš±ç¨±..." maxlength="8">
        <div class="player-select" id="player-buttons"></div>
    </div>

    <div class="container" id="game-ui" style="display:none;">
        <div class="header-info">
            <span>ğŸ“… ç¬¬ <span id="round-num">-</span> è¼ª</span>
            <span>ğŸ‘¤ <span id="my-name-display">-</span> (P<span id="my-id-display">-</span>)</span>
        </div>
        <div class="panel">
            <div id="display-job" style="text-align:center; font-weight:bold; color:var(--main);"></div>
            <div style="text-align:center; margin-bottom:10px;"><span id="my-talent" class="talent-tag"></span></div>
            <div id="turn-indicator" style="text-align:center; font-weight:bold; margin-bottom:15px;">ç­‰å¾…é€£ç·š...</div>
            <button id="roll-btn" class="btn btn-roll" onclick="handleRoll()">ğŸ² æ“²éª°å­</button>
            <button id="end-btn" class="btn btn-end" onclick="handleEndTurn()">ğŸ çµæŸå›åˆ</button>
            <div class="dice-display" id="dice-container"></div>
            <div id="res-list" style="text-align:center; font-size:14px; background:#eee; padding:5px; border-radius:5px;"></div>
        </div>
        <div class="market" id="market-container"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyA5x6Q2tMCR972PnHw6yzo8X1owq8n6Ppc", authDomain: "life-24445.firebaseapp.com", projectId: "life-24445", storageBucket: "life-24445.firebasestorage.app", messagingSenderId: "132936539069", appId: "1:132936539069:web:66224aaac8d89d3ace10d4" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const gameRef = ref(db, 'cv_game_state');

        let myId = null, gameState = {};
        const resColor = { 'é‡‘éŒ¢': '#f1c40f', 'æ™ºæ…§': '#3498db', 'äººéš›': '#e67e22', 'å¥åº·': '#9b59b6', 'ç¬‘è‡‰': '#2ecc71' };
        const cardPool = [{ n: 'çŸ½è°·å‰µæ¥­', cost: { 'æ™ºæ…§':2, 'äººéš›':1 }, gains: { 'é‡‘éŒ¢':4 } }, { n: 'ç’°çƒæ—…è¡Œ', cost: { 'é‡‘éŒ¢':2 }, gains: { 'äººéš›':2, 'å¥åº·':1 } }, { n: 'é†«å­¸é™¢', cost: { 'æ™ºæ…§':3 }, gains: { 'æ™ºæ…§':2, 'å¥åº·':2 } }, { n: 'è‚¡å¸‚é”äºº', cost: { 'é‡‘éŒ¢':2, 'æ™ºæ…§':1 }, gains: { 'é‡‘éŒ¢':3 } }, { n: 'æ¥µé™é‹å‹•', cost: { 'å¥åº·':3 }, gains: { 'å¥åº·':1, 'äººéš›':2 } }, { n: 'è—è¡“å‰µä½œ', cost: { 'æ™ºæ…§':1, 'äººéš›':1 }, gains: { 'æ™ºæ…§':2, 'å¥åº·':1 } }, { n: 'ä½µè³¼æ¡ˆ', cost: { 'é‡‘éŒ¢':3, 'æ™ºæ…§':1 }, gains: { 'é‡‘éŒ¢':5 } }, { n: 'é«˜ç§‘æŠ€ç ”ç™¼', cost: { 'æ™ºæ…§':3, 'é‡‘éŒ¢':1 }, gains: { 'æ™ºæ…§':4 } }];
        const talents = [{ n: "ç†è²¡å¤§å¸«", effect: { 'é‡‘éŒ¢': 1 } }, { n: "å­¸è€…æ°£æ¯", effect: { 'æ™ºæ…§': 1 } }, { n: "ç¤¾äº¤é”äºº", effect: { 'äººéš›': 1 } }, { n: "é‹å‹•å¥å°‡", effect: { 'å¥åº·': 1 } }, { n: "å¹¸é‹æ˜Ÿ", effect: {} }];

        for(let i=1; i<=10; i++) {
            const b = document.createElement('button'); b.className="btn"; b.style.background="var(--blue)"; b.innerText=`ä½ç½® ${i}`;
            b.id=`btn-p${i}`; b.onclick=()=>join(i); document.getElementById('player-buttons').appendChild(b);
        }

        onValue(gameRef, (snap) => {
            gameState = snap.val(); if(!gameState) return;
            for(let i=1; i<=10; i++) { if(gameState.players[i].active) { document.getElementById(`btn-p${i}`).style.background="#ccc"; document.getElementById(`btn-p${i}`).disabled=true; } }
            if(myId) render();
        });

        window.join = (id) => {
            const name = document.getElementById('user-name').value.trim(); if(!name) return alert("è«‹è¼¸å…¥åå­—");
            myId = id; const t = talents[Math.floor(Math.random()*talents.length)];
            update(ref(db, `cv_game_state/players/${id}`), { active: true, name: name, talent: t.n, tags: t.effect || { 'é‡‘éŒ¢':0 } });
            document.getElementById('setup-screen').style.display='none'; document.getElementById('game-ui').style.display='block';
            document.getElementById('my-id-display').innerText=id; document.getElementById('my-name-display').innerText=name;
        };

        function render() {
            const isTurn = gameState.currentTurn === myId; const p = gameState.players[myId];
            document.getElementById('round-num').innerText = gameState.currentRound;
            document.getElementById('display-job').innerText = `è·æ¥­ï¼š${p.job}`;
            document.getElementById('my-talent').innerText = `å¤©è³¦ï¼š${p.talent}`;
            document.getElementById('turn-indicator').innerText = isTurn ? "ğŸŸ¢ åˆ°ä½ äº†ï¼" : `ç­‰å¾…ç©å®¶ ${gameState.players[gameState.currentTurn].name || gameState.currentTurn}...`;
            document.getElementById('roll-btn').disabled = !isTurn || gameState.turnAction.hasRolled;
            document.getElementById('end-btn').disabled = !isTurn || !gameState.turnAction.hasRolled;
            document.getElementById('market-container').innerHTML = gameState.market.map((cid, idx) => {
                if(cid === null) return `<div class="card sold-out">å·²å…Œæ›</div>`;
                const c = cardPool[cid];
                return `<div class="card"><b>${c.n}</b><button class="btn btn-buy" onclick="buy(${idx})" ${!isTurn || !gameState.turnAction.hasRolled?'disabled':''}>å…Œæ›</button></div>`;
            }).join('');
            document.getElementById('dice-container').innerHTML = (gameState.turnAction.dice || []).map(d=>`<div class="dice" style="background:${resColor[d]}">${d==='ç¬‘è‡‰'?'ğŸ˜Š':d}</div>`).join('');
        }

        window.handleRoll = () => {
            const dice = []; const res = { 'é‡‘éŒ¢':0, 'æ™ºæ…§':0, 'äººéš›':0, 'å¥åº·':0, 'ç¬‘è‡‰':0 };
            for(let i=0; i<6; i++) { let r = Object.keys(resColor)[Math.floor(Math.random()*5)]; dice.push(r); res[r]++; }
            update(ref(db, 'cv_game_state/turnAction'), { hasRolled: true, dice, res });
        };

        window.buy = (idx) => {
            const card = cardPool[gameState.market[idx]], p = gameState.players[myId], currentRes = gameState.turnAction.res;
            let can = true; for(let [k,v] of Object.entries(card.cost)) { if((currentRes[k]||0)<v) can=false; }
            if(can) {
                const newTags = {...p.tags}; for(let [k,v] of Object.entries(card.gains)) newTags[k]=(newTags[k]||0)+v;
                const newM = [...gameState.market]; newM[idx]=null;
                update(ref(db, `cv_game_state/players/${myId}`), { tags: newTags });
                update(gameRef, { market: newM });
            } else alert("è³‡æºä¸è¶³");
        };

        window.handleEndTurn = () => {
            let nt = gameState.currentTurn + 1, nr = gameState.currentRound;
            if(nt > 10) { nt=1; nr++; update(gameRef, { market: [0,1,2,3,4,5].map(()=>Math.floor(Math.random()*cardPool.length)) }); }
            if(nr > 5) update(gameRef, { isOver: true });
            else update(gameRef, { currentTurn: nt, currentRound: nr, turnAction: { hasRolled: false, dice: [], res: {} } });
        };
    </script>
</body>
</html>
