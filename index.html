<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CV äººç”Ÿå±¥æ­· - æ•¸ä½è‡ªå‹•ç‰ˆ</title>
    <style>
        :root { --main: #2c3e50; --accent: #e67e22; --bg: #f5f7fa; --green: #27ae60; --red: #e74c3c; }
        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; background: var(--bg); margin: 0; padding: 10px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 500px; }
        
        /* å°è¦½åˆ— */
        .tab-nav { display: flex; gap: 8px; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 12px; border: none; border-radius: 8px; background: #ddd; cursor: pointer; font-weight: bold; font-size: 14px; transition: 0.2s; }
        .tab-btn.active { background: var(--main); color: white; }
        
        /* é¢æ¿è¨­è¨ˆ */
        .panel { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: none; }
        .panel.active { display: block; }

        /* ç©å®¶ç‹€æ…‹å€ */
        .player-info-card { text-align: center; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 20px; }
        .player-tag { background: var(--main); color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; display: inline-block; margin-bottom: 5px; }
        .secret-area { background: #f8f9fa; padding: 15px; border-radius: 10px; margin: 10px 0; border: 2px dashed #cbd5e0; position: relative; }
        .secret-text { display: none; color: var(--red); font-weight: bold; font-size: 1.3rem; }
        
        /* éª°å­èˆ‡è³‡æº */
        .dice-display { display: flex; justify-content: center; gap: 8px; margin: 15px 0; min-height: 70px; flex-wrap: wrap; }
        .dice { width: 60px; height: 60px; border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.8rem; box-shadow: 0 3px 0 rgba(0,0,0,0.2); transition: transform 0.1s; }
        .res-summary { background: #fff5eb; padding: 15px; border-radius: 10px; border: 1px solid #ffd8a8; text-align: center; margin: 10px 0; }

        /* å•†åº— */
        .market { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .card { border: 1px solid #ddd; padding: 12px; border-radius: 10px; text-align: center; background: white; }
        .btn-buy { background: var(--green); color: white; border: none; width: 100%; padding: 12px; border-radius: 6px; margin-top: 8px; cursor: pointer; font-weight: bold; }
        .btn-buy:active { transform: scale(0.98); }

        .btn-roll { background: var(--accent); color: white; border: none; padding: 15px; border-radius: 8px; font-size: 1.1rem; cursor: pointer; width: 100%; font-weight: bold; box-shadow: 0 4px 0 #b35d15; }
        .btn-roll:disabled { background: #95a5a6; box-shadow: none; cursor: not-allowed; transform: translateY(4px); }

        /* åˆ—è¡¨æ¨£å¼ */
        .others-item { border-bottom: 1px solid #edf2f7; padding: 12px 0; }
        .inventory-list { font-size: 13px; color: #4a5568; margin-top: 5px; }
    </style>
</head>
<body>

<div class="container">
    <div class="tab-nav">
        <button class="tab-btn active" onclick="switchTab('play')">ğŸ® æˆ‘çš„å›åˆ</button>
        <button class="tab-btn" onclick="switchTab('view')">ğŸ‘ï¸ æŸ¥çœ‹å…¨é«”</button>
        <button class="tab-btn" onclick="switchTab('admin')" style="background:#718096; color:white;">âš™ï¸ è¨­å®š</button>
    </div>

    <div id="panel-play" class="panel active">
        <div class="player-info-card">
            <div class="player-tag">ç›®å‰è¼ªåˆ°ï¼šPLAYER <span id="player-num">1</span></div>
            <h2 id="display-job" style="margin: 10px 0; color: var(--main);">è¼‰å…¥ä¸­...</h2>
            <div class="secret-area">
                <button onmousedown="showSecret(true)" onmouseup="showSecret(false)" ontouchstart="showSecret(true)" ontouchend="showSecret(false)" style="padding: 8px 15px; cursor: pointer;">ğŸ” æŒ‰ä½æŸ¥çœ‹éš±è—æ™‚æœŸ</button>
                <div id="secret-info" class="secret-text">---</div>
            </div>
            <div style="font-size: 14px;">æˆ‘çš„å¸¸é§å¤©è³¦ï¼š<b id="display-talent" style="color:var(--accent)">--</b></div>
        </div>

        <button id="roll-btn" class="btn-roll" onclick="rollDice()">ğŸ² æ“²éª°å­ (é–‹å§‹è¡Œå‹•)</button>
        
        <div class="dice-display" id="dice-container"></div>
        
        <div class="res-summary">
            <div id="res-list" style="font-weight: bold; font-size: 15px; color: #7b341e;">ç­‰å¾…æ“²éª°...</div>
            <div id="miracle-hint" style="color: #b8860b; font-weight: bold; font-size: 14px; margin-top: 5px;"></div>
        </div>

        <h3 style="font-size: 16px; border-left: 4px solid var(--main); padding-left: 10px; color: var(--main);">å¡ç‰Œå•†åº—</h3>
        <div class="market" id="market-container"></div>
    </div>

    <div id="panel-view" class="panel">
        <h3 style="color: var(--main);">å…¨é«”ç©å®¶æˆå°±æ¸…å–®</h3>
        <div id="others-container"></div>
    </div>

    <div id="panel-admin" class="panel">
        <h3 style="color: var(--red);">éŠæˆ²åˆå§‹åŒ– (GM å°ˆç”¨)</h3>
        <p style="font-size: 13px; color: #666;">é»æ“Šä¸‹æ–¹æŒ‰éˆ•å°‡æœƒé‡æ–°åˆ†é…æ‰€æœ‰ç©å®¶çš„æ™‚æœŸèˆ‡å¤©è³¦ï¼Œä¸¦å¾ç©å®¶ 1 é–‹å§‹ã€‚</p>
        <button onclick="initGame()" style="background:var(--red); color:white; padding:15px; width:100%; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">ğŸ”„ é‡æ–°æ´—ç‰Œä¸¦é–‹å§‹éŠæˆ²</button>
        <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
        <div id="gm-data-view" style="font-size:12px; line-height: 1.8; color: #4a5568;"></div>
    </div>
</div>

<script>
    const diceFaces = [
        { n: 'äººéš›', c: '#e67e22', i: 'ğŸ¤' }, { n: 'é‡‘éŒ¢', c: '#f1c40f', i: 'ğŸ’°' },
        { n: 'æ™ºæ…§', c: '#3498db', i: 'ğŸ’¡' }, { n: 'ç¬‘è‡‰', c: '#2ecc71', i: 'ğŸ˜Š' },
        { n: 'å“­è‡‰', c: '#e74c3c', i: 'ğŸ’€' }, { n: 'å¥åº·', c: '#9b59b6', i: 'ğŸ¥' }
    ];

    const secretPeriods = ["å¹¼å¹´æœŸ", "å…¥å­¸æœŸ", "é’æ˜¥æœŸ", "åŒ—æ¼‚æœŸ", "æˆå®¶æœŸ", "å£¯å¹´æœŸ", "å±æ©ŸæœŸ", "å›ç”˜æœŸ", "éš±å±…æœŸ", "å‚³å¥‡æœŸ"];
    const publicJobs = ["åµæ¢", "å»šå¸«", "å¤ªç©ºäºº", "ç•«å®¶", "é†«ç”Ÿ", "é§­å®¢", "è¾²å¤«", "è©©äºº", "å°éŠ", "æ©Ÿå¸«"];
    const talentOptions = ['é‡‘éŒ¢', 'æ™ºæ…§', 'äººéš›', 'ç¬‘è‡‰'];
    const cards = [
        {n:'è‚¡ç¥¨æŠ•è³‡', t:'é‡‘éŒ¢', q:2}, {n:'æŠ€èƒ½é€²ä¿®', t:'æ™ºæ…§', q:1}, {n:'æ¯æ—¥æ…¢è·‘', t:'å¥åº·', q:1},
        {n:'è±ªè¯å…¬å¯“', t:'é‡‘éŒ¢', q:4}, {n:'è·¨åœ‹äº¤å‹', t:'äººéš›', q:2}, {n:'å—æ¥µæ¢éšª', t:'ç¬‘è‡‰', q:2}
    ];

    let players = [];
    let currentIdx = 0;
    let currentRes = {};
    let hasMiracle = false;

    // åˆå§‹åŒ–
    function initGame() {
        let shuffled = [...secretPeriods].sort(() => Math.random() - 0.5);
        players = [];
        for(let i=0; i<10; i++) {
            players.push({ 
                id: i, 
                job: publicJobs[i], 
                secret: shuffled[i], 
                talent: talentOptions[Math.floor(Math.random() * 4)], 
                inventory: [] 
            });
        }
        renderMarket();
        currentIdx = 0;
        resetTurn();
        updateUI();
        switchTab('play');
        alert("ğŸ® éŠæˆ²æº–å‚™å°±ç·’ï¼è«‹ç©å®¶ 1 æ¥æ‰‹æ‰‹æ©Ÿã€‚");
    }

    function renderMarket() {
        document.getElementById('market-container').innerHTML = cards.map(c => `
            <div class="card"><b>${c.n}</b><br><small>ä»£åƒ¹: ${c.q} ${c.t}</small>
            <button class="btn-buy" onclick="buyCard('${c.n}','${c.t}',${c.q})">è³¼è²·</button></div>
        `).join('');
    }

    function switchTab(tabId) {
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('panel-' + tabId).classList.add('active');
        document.querySelector(`button[onclick="switchTab('${tabId}')"]`).classList.add('active');
        if(tabId === 'view') updateViewTab();
    }

    function resetTurn() {
        currentRes = {};
        hasMiracle = false;
        document.getElementById('dice-container').innerHTML = "";
        document.getElementById('res-list').innerText = "ç­‰å¾…æ“²éª°...";
        document.getElementById('miracle-hint').innerText = "";
        const rollBtn = document.getElementById('roll-btn');
        rollBtn.disabled = false;
        rollBtn.innerText = "ğŸ² æ“²éª°å­ (é–‹å§‹è¡Œå‹•)";
    }

    function updateUI() {
        if (players.length === 0) return;
        const p = players[currentIdx];
        document.getElementById('player-num').innerText = currentIdx + 1;
        document.getElementById('display-job').innerText = p.job;
        document.getElementById('display-talent').innerText = `ä¿åº• +1 ${p.talent}`;
        document.getElementById('gm-data-view').innerHTML = "<b>GM ç§˜å¯†æŸ¥é–±ï¼š</b><br>" + players.map((pl, i) => `P${i+1} ${pl.job}: ${pl.secret} (${pl.talent})`).join('<br>');
    }

    function showSecret(show) {
        const info = document.getElementById('secret-info');
        info.style.display = show ? 'block' : 'none';
        info.innerText = players[currentIdx] ? players[currentIdx].secret : "å°šæœªåˆå§‹åŒ–";
    }

    function rollDice() {
        const p = players[currentIdx];
        let cries = 0; let smiles = 0;
        currentRes = { 'äººéš›':0, 'é‡‘éŒ¢':0, 'æ™ºæ…§':0, 'ç¬‘è‡‰':0, 'å¥åº·':0 };
        currentRes[p.talent] = 1; // è§¸ç™¼å¸¸é§å¤©è³¦
        if(p.talent === 'ç¬‘è‡‰') smiles = 1;

        let html = "";
        for(let i=0; i<4; i++) {
            let r = diceFaces[Math.floor(Math.random()*6)];
            if(r.n === 'å“­è‡‰') cries++;
            else { 
                currentRes[r.n]++; 
                if(r.n === 'ç¬‘è‡‰') smiles++; 
            }
            html += `<div class="dice" style="background:${r.c}">${r.i}<br>${r.n}</div>`;
        }
        document.getElementById('dice-container').innerHTML = html;

        if(cries >= 3) {
            alert("ğŸ’€ å„é‹ï¼æ“²å‡º 3 å€‹å“­è‡‰ï¼Œå›åˆç›´æ¥çµæŸã€‚");
            nextPlayer();
        } else {
            hasMiracle = (smiles >= 3);
            document.getElementById('miracle-hint').innerText = hasMiracle ? "ğŸŒŸ é”æˆç¬‘è‡‰å¥‡è¹Ÿï¼å¯å…è²»å…Œæ›ä»»ä¸€å¡ç‰Œã€‚" : "";
            document.getElementById('roll-btn').disabled = true;
            document.getElementById('roll-btn').innerText = "è¡Œå‹•ä¸­...";
            renderResSummary();
            checkCanAffordAnything();
        }
    }

    function renderResSummary() {
        let txt = Object.entries(currentRes).filter(([k,v]) => v > 0).map(([k,v]) => `${k}x${v}`).join(' / ');
        document.getElementById('res-list').innerText = "å¯ç”¨è³‡æºï¼š" + (txt || "ç„¡");
    }

    function buyCard(name, type, qty) {
        if(Object.keys(currentRes).length === 0 && !hasMiracle) return alert("è«‹å…ˆæ“²éª°å­ï¼");
        const p = players[currentIdx];
        let bought = false;

        if(hasMiracle) {
            if(confirm(`ç¢ºå®šä½¿ç”¨ã€å¥‡è¹Ÿã€‘å…Œæ›ã€Œ${name}ã€ï¼Ÿ`)) {
                p.inventory.push(name + "(â˜…)");
                hasMiracle = false;
                document.getElementById('miracle-hint').innerText = "";
                bought = true;
            }
        } else if((currentRes[type] || 0) >= qty) {
            currentRes[type] -= qty;
            p.inventory.push(name);
            bought = true;
        } else {
            alert(`è³‡æºä¸è¶³ï¼è³¼è²·ã€Œ${name}ã€éœ€è¦ ${qty} å€‹ ${type}ã€‚`);
        }

        if(bought) {
            renderResSummary();
            checkCanAffordAnything();
        }
    }

    function checkCanAffordAnything() {
        if(hasMiracle) return; 
        const canAfford = cards.some(c => (currentRes[c.t] || 0) >= c.q);
        if(!canAfford) {
            setTimeout(() => {
                alert("ğŸ“¢ è³‡æºå·²è€—ç›¡ï¼Œå³å°‡åˆ‡æ›è‡³ä¸‹ä¸€ä½ç©å®¶ã€‚");
                nextPlayer();
            }, 600);
        }
    }

    function nextPlayer() {
        currentIdx = (currentIdx + 1) % 10;
        resetTurn();
        updateUI();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function updateViewTab() {
        document.getElementById('others-container').innerHTML = players.map((p, i) => `
            <div class="others-item">
                <span class="player-tag">P${i+1} ${p.job}</span>
                <div class="inventory-list">æˆå°±ï¼š${p.inventory.length > 0 ? p.inventory.join(', ') : 'å°šæœªç²å¾—'}</div>
            </div>
        `).join('');
    }

    // å•Ÿå‹•
    initGame();
</script>
</body>
</html>
