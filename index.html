<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CV ç©å®¶ç«¯</title>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; text-align: center; padding: 10px; }
        .card { background: white; border-radius: 10px; padding: 15px; margin: 10px 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn { padding: 10px 20px; border-radius: 5px; border: none; cursor: pointer; font-weight: bold; width: 100%; margin: 5px 0; }
        .btn-roll { background: #e67e22; color: white; }
        .btn-buy { background: #27ae60; color: white; }
        #setup { position: fixed; inset: 0; background: white; z-index: 10; display: flex; flex-direction: column; justify-content: center; padding: 20px; }
    </style>
</head>
<body>
    <div id="setup">
        <h2>ğŸ§¬ CV äººç”Ÿå±¥æ­·</h2>
        <input type="text" id="name" placeholder="è¼¸å…¥æš±ç¨±" style="padding:10px; margin-bottom:10px;">
        <div id="p-btns" style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;"></div>
    </div>

    <div id="game" style="display:none;">
        <h3 id="info">è¼‰å…¥ä¸­...</h3>
        <button class="btn btn-roll" id="rollBtn" onclick="doRoll()">ğŸ² æ“²éª°å­</button>
        <div id="diceDisp" style="margin: 10px 0; font-size: 20px;"></div>
        <div id="market"></div>
        <button class="btn" style="background:#2c3e50; color:white;" onclick="doEnd()">ğŸ çµæŸå›åˆ</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const config = { apiKey: "AIzaSyA5x6Q2tMCR972PnHw6yzo8X1owq8n6Ppc", authDomain: "life-24445.firebaseapp.com", databaseURL: "https://life-24445-default-rtdb.firebaseio.com", projectId: "life-24445" };
        const app = initializeApp(config);
        const db = getDatabase(app);
        const gRef = ref(db, 'cv_game_state');
        let myId, state;

        for(let i=1; i<=10; i++) {
            let b = document.createElement('button'); b.innerText = "ä½ç½® "+i; b.className="btn"; b.style.background="#3498db"; b.style.color="white";
            b.onclick = () => {
                let n = document.getElementById('name').value; if(!n) return alert("è«‹è¼¸å");
                myId = i; update(ref(db, `cv_game_state/players/${i}`), { active:true, name:n, tags:{'é‡‘éŒ¢':0} });
                document.getElementById('setup').style.display='none'; document.getElementById('game').style.display='block';
            };
            document.getElementById('p-btns').appendChild(b);
        }

        onValue(gRef, (s) => {
            state = s.val(); if(!state) return;
            let isMe = state.currentTurn == myId;
            document.getElementById('info').innerText = `ç¬¬ ${state.currentRound} è¼ª - ${isMe ? "ğŸ”´ ä½ çš„å›åˆ" : "ç­‰å¾…ä¸­..."}`;
            document.getElementById('rollBtn').disabled = !isMe || state.turnAction.hasRolled;
            document.getElementById('diceDisp').innerText = (state.turnAction.dice || []).join(' ');
            document.getElementById('market').innerHTML = state.market.map((c,idx) => `
                <div class="card">æˆå°± ${c===null?'å·²å”®å‡º':c} <button class="btn btn-buy" onclick="doBuy(${idx})" ${!isMe || !state.turnAction.hasRolled?'disabled':''}>å…Œæ›</button></div>
            `).join('');
        });

        window.doRoll = () => {
            let ds = ['é‡‘éŒ¢','æ™ºæ…§','äººéš›','å¥åº·','ç¬‘è‡‰'];
            let res = []; for(let i=0; i<6; i++) res.push(ds[Math.floor(Math.random()*5)]);
            update(ref(db, 'cv_game_state/turnAction'), { hasRolled: true, dice: res });
        };
        window.doBuy = (idx) => {
            let nm = [...state.market]; nm[idx] = null;
            update(gRef, { market: nm });
        };
        window.doEnd = () => {
            let nt = state.currentTurn + 1; if(nt > 10) nt = 1;
            update(gRef, { currentTurn: nt, turnAction: {hasRolled:false, dice:[]} });
        };
    </script>
</body>
</html>
