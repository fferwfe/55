<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>CV ä¸Šå¸æ§åˆ¶ä¸­å¿ƒ - è‡ªç”±æ¨¡å¼</title>
    <style>
        body { font-family: sans-serif; background: #1a1a2e; color: #fff; padding: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .card { background: #16213e; padding: 15px; border-radius: 12px; border: 1px solid #4ecca3; position: relative; }
        input { background: #0f3460; color: white; border: 1px solid #444; padding: 5px; width: 90%; margin: 5px 0; border-radius: 4px; }
        .btn { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-right: 5px; }
        .btn-update { background: #4ecca3; color: #1a1a2e; }
        .btn-refresh { background: #3498db; color: white; font-size: 1.1rem; }
        .btn-reset { background: #e94560; color: white; }
        .status-on { color: #4ecca3; font-size: 12px; }
        .status-off { color: #666; font-size: 12px; }
    </style>
</head>
<body>
    <h1>ğŸ› ï¸ CV è‡ªç”±æ¨¡å¼ä¸Šå¸ä¸­å¿ƒ</h1>
    
    <div style="background: #0f3460; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
        <button class="btn btn-refresh" onclick="window.randomizeMarket()">ğŸ² éš¨æ©Ÿåˆ·æ–°å…¨å ´å¡ç‰‡</button>
        <button class="btn btn-reset" onclick="window.initGame()">ğŸ”¥ é‡ç½®å…¨å ´è³‡æ–™</button>
    </div>

    <h2>ğŸ›’ å¸‚å ´å³æ™‚ç‹€æ…‹ (å¯æ‰‹å‹•ä¿®æ”¹)</h2>
    <div id="market-editor" class="grid"></div>

    <h2>ğŸ‘¥ ç©å®¶ç›£æ§ (å³æ™‚åŒæ­¥è³‡æº)</h2>
    <div id="player-monitor" class="grid"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const config = { databaseURL: "https://life-24445-default-rtdb.asia-southeast1.firebasedatabase.app" };
    const app = initializeApp(config);
    const db = getDatabase(app);
    const gRef = ref(db, 'cv_game_state');

    // æ“´å±•å¡ç‰‡åº«
    const cardPool = [
        { n: "å‰µæ¥­å¤§å¸«", c: "æ™ºæ…§x3,é‡‘éŒ¢x1", g: "é‡‘éŒ¢x4" },
        { n: "ç’°çƒæ—…è¡Œ", c: "é‡‘éŒ¢x2", g: "äººéš›x2,å¥åº·x1" },
        { n: "å¥§é‹é¸æ‰‹", c: "å¥åº·x4", g: "å¥åº·x2,äººéš›x1" },
        { n: "çŸ¥åä½œå®¶", c: "æ™ºæ…§x2", g: "æ™ºæ…§x2,äººéš›x1" },
        { n: "ç±³å…¶æ—ä¸»å»š", c: "å¥åº·x1,æ™ºæ…§x1", g: "äººéš›x2" },
        { n: "è‚¡ç¥¨ç¶“ç´€", c: "é‡‘éŒ¢x2,æ™ºæ…§x1", g: "é‡‘éŒ¢x3" },
        { n: "æ…ˆå–„å®¶", c: "é‡‘éŒ¢x3", g: "äººéš›x4" },
        { n: "å†¥æƒ³å°å¸«", c: "æ™ºæ…§x1", g: "å¥åº·x3" },
        { n: "é§­å®¢ç‰¹å·¥", c: "æ™ºæ…§x4", g: "é‡‘éŒ¢x2,æ™ºæ…§x1" }
    ];

    window.initGame = () => {
        if(!confirm("ç¢ºå®šè¦é‡ç½®æ‰€æœ‰äººçš„è³‡æ–™å—ï¼Ÿ")) return;
        const ps = {};
        const jobs = ["é†«ç”Ÿ","å·¥ç¨‹å¸«","ç•«å®¶","åµæ¢","å»šå¸«","æ©Ÿå¸«","è¾²å¤«","è©©äºº","å°éŠ","å¤ªç©ºäºº"];
        for(let i=1; i<=10; i++) ps[i] = { id:i, job:jobs[i-1], allTags:{'é‡‘éŒ¢':0,'æ™ºæ…§':0,'äººéš›':0,'å¥åº·':0}, extraScore:0, active: false };
        set(gRef, { currentRound: 1, marketCards: cardPool.slice(0, 6).map(x => ({name:x.n, cost:x.c, gains:x.g})), players: ps });
    };

    window.randomizeMarket = () => {
        const shuffled = cardPool.sort(() => 0.5 - Math.random());
        const selected = shuffled.slice(0, 6).map(x => ({ name: x.n, cost: x.c, gains: x.g }));
        update(gRef, { marketCards: selected });
    };

    onValue(gRef, (snap) => {
        const data = snap.val(); if(!data) return;
        // æ¸²æŸ“å¸‚å ´
        document.getElementById('market-editor').innerHTML = data.marketCards.map((c, i) => `
            <div class="card">
                <b>å¡æ§½ ${i+1}</b><br>
                å“ç›¸: <input id="n-${i}" value="${c.name}"><br>
                ä»£åƒ¹: <input id="c-${i}" value="${c.cost}"><br>
                çå‹µ: <input id="g-${i}" value="${c.gains}"><br>
                <button class="btn btn-update" onclick="window.saveCard(${i})">æ›´æ–°æ­¤å¡</button>
            </div>
        `).join('');
        // æ¸²æŸ“ç©å®¶
        document.getElementById('player-monitor').innerHTML = Object.values(data.players).map(p => `
            <div class="card">
                <b>P${p.id}: ${p.job}</b> <span class="${p.active?'status-on':'status-off'}">${p.active?'â— åœ¨ç·š':'â—‹ é›¢ç·š'}</span><br>
                ç¾æœ‰æ¨™ç±¤: <small>${JSON.stringify(p.allTags)}</small><br>
                é¡å¤–åˆ†æ•¸: <b>${p.extraScore || 0}</b>
                <button onclick="window.addScore(${p.id}, 1)">+1</button>
                <button onclick="window.addScore(${p.id}, -1)">-1</button>
            </div>
        `).join('');
    });

    window.saveCard = (i) => {
        const name = document.getElementById(`n-${i}`).value;
        const cost = document.getElementById(`c-${i}`).value;
        const gains = document.getElementById(`g-${i}`).value;
        update(ref(db, `cv_game_state/marketCards/${i}`), { name, cost, gains });
    };

    window.addScore = (id, amt) => {
        const pRef = ref(db, `cv_game_state/players/${id}`);
        onValue(pRef, (s) => {
            update(pRef, { extraScore: (s.val().extraScore || 0) + amt });
        }, { onlyOnce: true });
    };
</script>
</body>
</html>
