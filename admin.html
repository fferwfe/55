<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>CV çµ‚æ¥µä¸Šå¸ä¸»æ§å°</title>
    <style>
        body { font-family: sans-serif; background: #1a1a2e; color: #fff; padding: 20px; }
        .section { background: #16213e; border-radius: 15px; padding: 20px; margin-bottom: 20px; border: 1px solid #0f3460; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .card { background: #0f3460; padding: 15px; border-radius: 10px; }
        input, select { background: #1a1a2e; color: white; border: 1px solid #444; padding: 5px; border-radius: 5px; margin: 2px; }
        .btn { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-red { background: #e94560; color: white; }
        .btn-green { background: #0f969c; color: white; }
        .btn-blue { background: #3498db; color: white; }
    </style>
</head>
<body>

<h1>ğŸ› ï¸ CV çµ‚æ¥µä¸Šå¸ä¸»æ§å°</h1>

<div class="section">
    <h2>ğŸ“¡ å…¨åŸŸæ ¸å¿ƒæ§åˆ¶</h2>
    <button class="btn btn-red" onclick="initGame()">ğŸ”¥ é‡ç½®å…¨é«”éŠæˆ²æ•¸æ“š</button>
    <button class="btn btn-blue" onclick="forceNextTurn()">â© å¼·åˆ¶è·³éå›åˆ</button>
</div>

<div class="section">
    <h2>ğŸ›’ å¸‚å ´å¡ç‰‡ç·¨è¼¯èˆ‡åˆ¶å®š (å³æ™‚ç”Ÿæ•ˆ)</h2>
    <div id="market-editor" class="grid"></div>
</div>

<div class="section">
    <h2>ğŸ‘¥ æ‰€æœ‰ç©å®¶æ•¸æ“šç›£æ§ & åŠ åˆ†</h2>
    <div id="player-monitor" class="grid"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    // é€™è£¡ä½¿ç”¨äº†ä½ æä¾›çš„æ­£ç¢ºæ–°åŠ å¡å€åŸŸ URL
    const config = { 
        apiKey: "AIzaSyA5x6Q2tMCR972PnHw6yzo8X1owq8n6Ppc", 
        authDomain: "life-24445.firebaseapp.com", 
        databaseURL: "https://life-24445-default-rtdb.asia-southeast1.firebasedatabase.app", 
        projectId: "life-24445" 
    };
    const app = initializeApp(config);
    const db = getDatabase(app);
    const gRef = ref(db, 'cv_game_state');

    onValue(gRef, (snap) => {
        const state = snap.val();
        if (!state) return;
        renderMarket(state.marketCards);
        renderPlayers(state.players);
    });

    // --- åˆå§‹åŒ–åŠŸèƒ½ ---
    window.initGame = () => {
        if(!confirm("é€™æœƒæ¸…ç©ºæ‰€æœ‰å¡ç‰‡èˆ‡ç©å®¶è³‡æ–™ï¼Œç¢ºå®šï¼Ÿ")) return;
        let players = {};
        for(let i=1; i<=10; i++) players[i] = { id:i, active:false, name:"", tags:{'é‡‘éŒ¢':0,'æ™ºæ…§':0,'äººéš›':0,'å¥åº·':0}, extraScore:0 };
        
        // åˆå§‹ 6 å¼µé è¨­å¡ç‰‡
        let marketCards = [
            { id:0, name: "é è¨­æˆå°±A", cost: "é‡‘éŒ¢:1", gain: "æ™ºæ…§:1" },
            { id:1, name: "é è¨­æˆå°±B", cost: "æ™ºæ…§:1", gain: "å¥åº·:1" },
            { id:2, name: "é è¨­æˆå°±C", cost: "äººéš›:1", gain: "é‡‘éŒ¢:1" },
            { id:3, name: "é è¨­æˆå°±D", cost: "å¥åº·:1", gain: "äººéš›:1" },
            { id:4, name: "é è¨­æˆå°±E", cost: "é‡‘éŒ¢:2", gain: "æ™ºæ…§:2" },
            { id:5, name: "é è¨­æˆå°±F", cost: "æ™ºæ…§:2", gain: "å¥åº·:2" }
        ];

        set(gRef, {
            currentRound: 1, currentTurn: 1,
            marketCards: marketCards,
            players: players,
            turnAction: { hasRolled: false, dice: [] }
        }).then(() => alert("åˆå§‹åŒ–æˆåŠŸï¼"));
    };

    // --- å¸‚å ´å¡ç‰‡ç·¨è¼¯ ---
    function renderMarket(cards) {
        const cont = document.getElementById('market-editor');
        cont.innerHTML = cards.map((c, idx) => `
            <div class="card">
                <b>ä½ç½® ${idx+1}</b><br>
                å“ç›¸: <input id="m-n-${idx}" value="${c.name}" onchange="updateCard(${idx})"><br>
                æ¢ä»¶: <input id="m-c-${idx}" value="${c.cost}" onchange="updateCard(${idx})"><br>
                çå‹µ: <input id="m-g-${idx}" value="${c.gain}" onchange="updateCard(${idx})">
            </div>
        `).join('');
    }

    window.updateCard = (idx) => {
        const name = document.getElementById(`m-n-${idx}`).value;
        const cost = document.getElementById(`m-c-${idx}`).value;
        const gain = document.getElementById(`m-g-${idx}`).value;
        update(ref(db, `cv_game_state/marketCards/${idx}`), { name, cost, gain });
    };

    // --- ç©å®¶ç›£æ§èˆ‡åŠ åˆ† ---
    function renderPlayers(players) {
        const cont = document.getElementById('player-monitor');
        cont.innerHTML = Object.values(players).filter(p => p.active).map(p => `
            <div class="card">
                <b>${p.name} (ä½ç½® ${p.id})</b><br>
                æ‰‹å‹•é¡å¤–åŠ åˆ†: <b>${p.extraScore || 0}</b><br>
                <button class="btn btn-green" onclick="adjustScore(${p.id}, 1)">+1</button>
                <button class="btn btn-red" onclick="adjustScore(${p.id}, -1)">-1</button>
                <hr>
                <small>ç›®å‰æ¨™ç±¤: é‡‘éŒ¢:${p.tags.é‡‘éŒ¢}, æ™ºæ…§:${p.tags.æ™ºæ…§}, äººéš›:${p.tags.äººéš›}, å¥åº·:${p.tags.å¥åº·}</small>
            </div>
        `).join('');
    }

    window.adjustScore = (id, amt) => {
        onValue(ref(db, `cv_game_state/players/${id}/extraScore`), (s) => {
            update(ref(db, `cv_game_state/players/${id}`), { extraScore: (s.val() || 0) + amt });
        }, { onlyOnce: true });
    };

    window.forceNextTurn = () => {
        onValue(gRef, (s) => {
            let next = (s.val().currentTurn % 10) + 1;
            update(gRef, { currentTurn: next, turnAction: {hasRolled:false, dice:[]} });
        }, { onlyOnce: true });
    };
</script>
</body>
</html>
