<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CV ç©å®¶æ“ä½œ</title>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; text-align: center; padding: 15px; }
        .card { background: white; border-radius: 10px; padding: 15px; margin: 10px 0; border: 1px solid #ddd; }
        .btn { padding: 15px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; width: 100%; margin: 5px 0; }
        #setup { position: fixed; inset: 0; background: white; z-index: 100; display: flex; flex-direction: column; justify-content: center; padding: 20px; }
    </style>
</head>
<body>
    <div id="setup">
        <h2>ğŸ§¬ CV åŠ å…¥éŠæˆ²</h2>
        <input type="text" id="p-name" placeholder="è¼¸å…¥æš±ç¨±" style="padding:15px; margin-bottom:10px; font-size:1rem;">
        <div id="join-btns" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;"></div>
    </div>

    <div id="game-ui" style="display:none;">
        <h3 id="turn-info">è¼‰å…¥ä¸­...</h3>
        <button class="btn" style="background:#e67e22; color:white;" id="rollBtn" onclick="doRoll()">ğŸ² æ“²éª°å­</button>
        <div id="diceDisp" style="margin: 20px 0; font-size: 24px;"></div>
        <div id="market-ui"></div>
        <button class="btn" style="background:#34495e; color:white;" onclick="doEnd()">ğŸ çµæŸå›åˆ</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const config = { 
            apiKey: "AIzaSyA5x6Q2tMCR972PnHw6yzo8X1owq8n6Ppc", 
            authDomain: "life-24445.firebaseapp.com", 
            databaseURL: "https://life-24445-default-rtdb.asia-southeast1.firebasedatabase.app", 
            projectId: "life-24445" 
        };
        const app = initializeApp(config);
        const db = getDatabase(app);
        const gRef = ref(db, 'cv_game_state');
        let myId, state;

        for(let i=1; i<=10; i++) {
            let b = document.createElement('button'); b.innerText = "ä½ç½® "+i; b.className="btn"; b.style.background="#3498db"; b.style.color="white";
            b.id = "j-"+i;
            b.onclick = () => {
                let n = document.getElementById('p-name').value; if(!n) return alert("è«‹è¼¸å…¥åå­—");
                myId = i; update(ref(db, `cv_game_state/players/${i}`), { active:true, name:n });
                document.getElementById('setup').style.display='none'; document.getElementById('game-ui').style.display='block';
            };
            document.getElementById('join-btns').appendChild(b);
        }

        onValue(gRef, (s) => {
            state = s.val(); if(!state) return;
            for(let i=1; i<=10; i++) if(state.players[i].active) { let btn = document.getElementById("j-"+i); if(btn) btn.disabled=true; }
            if(!myId) return;
            let isMe = state.currentTurn == myId;
            document.getElementById('turn-info').innerText = isMe ? "ğŸŸ¢ ä½ çš„å›åˆ" : "â³ ç­‰å¾… P" + state.currentTurn;
            document.getElementById('rollBtn').disabled = !isMe || state.turnAction.hasRolled;
            document.getElementById('diceDisp').innerText = (state.turnAction.dice || []).join(' ');
            document.getElementById('market-ui').innerHTML = (state.marketCards || []).map((c, idx) => `
                <div class="card">
                    <b>${c.name}</b><br><small>æ¢ä»¶: ${c.cost}</small><br>
                    <button class="btn" style="background:#27ae60; color:white; padding:5px;" onclick="buy(${idx})" ${!isMe?'disabled':''}>å…Œæ›</button>
                </div>
            `).join('');
        });

        window.doRoll = () => {
            let ds = ['ğŸ’°','ğŸ§ ','ğŸ¤','ğŸƒ','ğŸ˜Š'];
            let res = []; for(let i=0; i<6; i++) res.push(ds[Math.floor(Math.random()*5)]);
            update(ref(db, 'cv_game_state/turnAction'), { hasRolled: true, dice: res });
        };

        window.doEnd = () => {
            if(!state) return;
            let n = (state.currentTurn % 10) + 1;
            update(gRef, { currentTurn: n, turnAction: {hasRolled:false, dice:[]} });
        };
    </script>
</body>
</html>
