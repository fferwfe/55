<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>CV çµ‚æ¥µä¸Šå¸æ¨¡å¼</title>
    <style>
        body { font-family: sans-serif; background: #1a1a2e; color: #fff; padding: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .card { background: #16213e; padding: 15px; border-radius: 12px; border: 1px solid #4ecca3; }
        input { background: #0f3460; color: white; border: 1px solid #444; padding: 5px; width: 80%; margin: 5px 0; }
        .btn { padding: 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-add { background: #4ecca3; color: #1a1a2e; }
        .btn-reset { background: #e94560; color: white; }
    </style>
</head>
<body>
    <h1>ğŸ› ï¸ CV ä¸Šå¸æ§åˆ¶ä¸­å¿ƒ</h1>
    <div style="margin-bottom: 20px;">
        <button class="btn btn-reset" onclick="initGame()">ğŸ”¥ é‡ç½®ä¸¦å¼·åˆ¶é‡æ–°åˆå§‹åŒ– (å…¨å ´æ¸…ç©º)</button>
    </div>

    <h2>ğŸ›’ å¸‚å ´å“ç›¸èˆ‡æ¢ä»¶åˆ¶å®š (å³æ™‚åŒæ­¥)</h2>
    <div id="market-editor" class="grid"></div>

    <h2>ğŸ‘¥ å…¨ç©å®¶ç›£æ§ (èº«ä»½ã€è³‡æºã€åŠ åˆ†)</h2>
    <div id="player-monitor" class="grid"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const config = { databaseURL: "https://life-24445-default-rtdb.asia-southeast1.firebasedatabase.app" };
    const app = initializeApp(config);
    const db = getDatabase(app);
    const gRef = ref(db, 'cv_game_state');

    window.initGame = () => {
        if(!confirm("ç¢ºå®šè¦é‡ç½®å—ï¼Ÿ")) return;
        const ps = {};
        const jobs = ["é†«ç”Ÿ","å·¥ç¨‹å¸«","ç•«å®¶","åµæ¢","å»šå¸«","æ©Ÿå¸«","è¾²å¤«","è©©äºº","å°éŠ","å¤ªç©ºäºº"];
        for(let i=1; i<=10; i++) ps[i] = { id:i, job:jobs[i-1], allTags:{'é‡‘éŒ¢':0,'æ™ºæ…§':0,'äººéš›':0,'å¥åº·':0}, extraScore:0, active: false };
        
        set(gRef, {
            currentRound: 1, currentTurn: 1,
            marketCards: [
                { name: "çŸ½è°·å‰µæ¥­", cost: "æ™ºæ…§x2,äººéš›x1", gains: "é‡‘éŒ¢x4" },
                { name: "ç’°çƒæ—…è¡Œ", cost: "é‡‘éŒ¢x2", gains: "äººéš›x2,å¥åº·x1" },
                { name: "é†«å­¸é™¢", cost: "æ™ºæ…§x3", gains: "æ™ºæ…§x2,å¥åº·x2" },
                { name: "è‚¡å¸‚å¤§æˆ¶", cost: "é‡‘éŒ¢x2,æ™ºæ…§x1", gains: "é‡‘éŒ¢x3" },
                { name: "ç‘œçˆå¤§å¸«", cost: "æ™ºæ…§x1,å¥åº·x1", gains: "å¥åº·x2" },
                { name: "é›»éŸ³DJ", cost: "äººéš›x1", gains: "äººéš›x2" }
            ],
            players: ps,
            turnAction: { hasRolled: false, dice: [], currentRes: {} }
        });
    };

    onValue(gRef, (snap) => {
        const data = snap.val(); if(!data) return;
        // æ¸²æŸ“å¸‚å ´ç·¨è¼¯
        document.getElementById('market-editor').innerHTML = data.marketCards.map((c, i) => `
            <div class="card">
                <b>ä½ç½® ${i+1}</b><br>
                å“ç›¸: <input id="n-${i}" value="${c.name}"><br>
                æ¢ä»¶: <input id="c-${i}" value="${c.cost}"><br>
                çå‹µ: <input id="g-${i}" value="${c.gains}"><br>
                <button class="btn btn-add" onclick="saveCard(${i})">å„²å­˜æ›´æ–°</button>
            </div>
        `).join('');
        // æ¸²æŸ“ç©å®¶ç›£æ§
        document.getElementById('player-monitor').innerHTML = Object.values(data.players).map(p => `
            <div class="card" style="${p.active?'border:2px solid gold':''}">
                <b>P${p.id}: ${p.job} ${p.active?'(åœ¨ç·š)':'(é›¢ç·š)'}</b><br>
                é¡å¤–åŠ åˆ†: <b>${p.extraScore}</b>
                <button onclick="addScore(${p.id}, 1)">+1</button>
                <button onclick="addScore(${p.id}, -1)">-1</button>
                <hr>
                <small>ç¾æœ‰è³‡æº: ${JSON.stringify(p.allTags)}</small>
            </div>
        `).join('');
    });

    window.saveCard = (i) => {
        const name = document.getElementById(`n-${i}`).value;
        const cost = document.getElementById(`c-${i}`).value;
        const gains = document.getElementById(`g-${i}`).value;
        update(ref(db, `cv_game_state/marketCards/${i}`), { name, cost, gains });
    };

    window.addScore = (id, amt) => {
        onValue(ref(db, `cv_game_state/players/${id}/extraScore`), (s) => {
            update(ref(db, `cv_game_state/players/${id}`), { extraScore: (s.val() || 0) + amt });
        }, { onlyOnce: true });
    };
</script>
</body>
</html>
