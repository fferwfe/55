<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CV äººç”Ÿå±¥æ­· - ç©å®¶ç«¯</title>
    <style>
        :root { --main: #2c3e50; --accent: #e67e22; --bg: #f5f7fa; --green: #27ae60; --red: #e74c3c; --blue: #3498db; --gold: #f1c40f; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 500px; }
        .header-info { display: flex; justify-content: space-between; background: var(--main); color: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; font-weight: bold; }
        .panel { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 10px; }
        .dice-display { display: flex; justify-content: center; gap: 6px; margin: 10px 0; }
        .dice { width: 45px; height: 45px; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.2rem; }
        .market { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .card { border: 1px solid #eee; padding: 10px; border-radius: 10px; background: #fafafa; min-height: 120px; text-align: center; }
        .btn { padding: 12px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; color: white; width: 100%; margin: 5px 0; }
        #setup { position: fixed; inset: 0; background: white; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
    </style>
</head>
<body>
    <div id="setup">
        <h2>ğŸ§¬ é¸æ“‡ä½ çš„ç©å®¶ç·¨è™Ÿ</h2>
        <div id="p-btns" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;"></div>
    </div>

    <div class="container" id="game-ui" style="display:none;">
        <div class="header-info">
            <span>ğŸ“… ç¬¬ <span id="round-num">1</span> è¼ª</span>
            <span>ğŸ‘¤ ç©å®¶ <span id="p-id"></span></span>
        </div>
        <div class="panel">
            <h2 id="job-title">è¼‰å…¥ä¸­...</h2>
            <div id="dice-container" class="dice-display"></div>
            <button class="btn" style="background:var(--accent)" id="roll-btn" onclick="roll()">ğŸ² æ“²éª°å­</button>
            <div id="res-summary" style="margin: 10px; font-weight: bold; color: var(--main);">è«‹å…ˆæ“²éª°å­</div>
        </div>
        <div class="market" id="market-list"></div>
        <button class="btn" style="background:var(--main)" onclick="endTurn()">ğŸ çµæŸå›åˆ</button>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const config = { databaseURL: "https://life-24445-default-rtdb.asia-southeast1.firebasedatabase.app" };
    const app = initializeApp(config);
    const db = getDatabase(app);
    let myId, state;

    // åˆå§‹åŒ–æŒ‰éˆ•
    const pContainer = document.getElementById('p-btns');
    for(let i=1; i<=10; i++) {
        let b = document.createElement('button'); b.className="btn"; b.style.background="var(--blue)"; b.innerText="ç©å®¶ "+i;
        b.onclick = () => { myId=i; update(ref(db, `cv_game_state/players/${i}`), {active:true}); document.getElementById('setup').style.display='none'; document.getElementById('game-ui').style.display='block'; };
        pContainer.appendChild(b);
    }

    onValue(ref(db, 'cv_game_state'), (snap) => {
        state = snap.val(); if(!state) return;
        const isMyTurn = state.currentTurn == myId;
        document.getElementById('p-id').innerText = myId + (isMyTurn ? " (ä½ çš„å›åˆ)" : "");
        document.getElementById('round-num').innerText = state.currentRound;
        document.getElementById('job-title').innerText = state.players[myId].job;
        document.getElementById('roll-btn').disabled = !isMyTurn || state.turnAction.hasRolled;

        // æ¸²æŸ“éª°å­èˆ‡å¸‚å ´... (åŒä¹‹å‰çš„é‚è¼¯)
        renderMarket(isMyTurn);
    });

    window.roll = () => {
        const icons = ['ğŸ’°','ğŸ§ ','ğŸ¤','ğŸƒ','ğŸ˜Š'];
        const res = []; for(let i=0; i<6; i++) res.push(icons[Math.floor(Math.random()*5)]);
        update(ref(db, 'cv_game_state/turnAction'), { hasRolled: true, dice: res });
    };

    function renderMarket(isMyTurn) {
        document.getElementById('market-list').innerHTML = state.marketCards.map((c, i) => `
            <div class="card">
                <b>${c.name}</b><br><small>${c.cost}</small><br>
                <button class="btn" style="background:var(--green); font-size:12px;" ${!isMyTurn?'disabled':''} onclick="buy(${i})">å…Œæ›</button>
            </div>
        `).join('');
    }

    window.endTurn = () => {
        let next = (state.currentTurn % 10) + 1;
        update(ref(db, 'cv_game_state'), { currentTurn: next, turnAction: {hasRolled:false, dice:[]} });
    };
</script>
</body>
</html>
